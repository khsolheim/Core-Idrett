---
phase: "02-type-safety"
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - "backend/lib/helpers/parsing_helpers.dart"
  - "backend/lib/models/season.dart"
  - "backend/test/helpers/parsing_helpers_test.dart"
  - "backend/test/models/season_test.dart"
autonomous: true

must_haves:
  truths:
    - "Safe parsing helpers exist for all primitive types used in backend models"
    - "Each helper throws FormatException with descriptive message on invalid input"
    - "DateTime helpers handle both String and DateTime inputs from Supabase"
    - "LeaderboardEntry fromJson/toJson use the same JSON key for optedOut"
  artifacts:
    - path: "backend/lib/helpers/parsing_helpers.dart"
      provides: "Safe type extraction functions"
      contains: "safeString"
    - path: "backend/test/helpers/parsing_helpers_test.dart"
      provides: "Unit tests for all parsing helpers"
      min_lines: 100
  key_links:
    - from: "backend/lib/helpers/parsing_helpers.dart"
      to: "backend/lib/models/*.dart"
      via: "import and usage in fromJson factories"
      pattern: "import.*parsing_helpers"
---

<objective>
Create the safe parsing helper library that all subsequent model, service, and handler migrations will depend on. Fix the known LeaderboardEntry JSON key mismatch. Write comprehensive tests for all helpers using TDD.

Purpose: Establish the foundation helpers that eliminate unsafe `as` casts across the entire backend. Every subsequent plan imports this file.
Output: `parsing_helpers.dart` with tested safe extraction functions, fixed LeaderboardEntry key mismatch.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-type-safety-validation/02-RESEARCH.md
@backend/lib/api/helpers/validation_helpers.dart
@backend/lib/api/helpers/request_helpers.dart
@backend/lib/helpers/collection_helpers.dart
@backend/lib/models/season.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create parsing_helpers.dart with TDD</name>
  <files>
    backend/lib/helpers/parsing_helpers.dart
    backend/test/helpers/parsing_helpers_test.dart
  </files>
  <action>
Use TDD (RED then GREEN) to create `backend/lib/helpers/parsing_helpers.dart` with these functions:

**Required helpers** (each extracts a typed value from `Map<String, dynamic>`):

1. `String safeString(Map<String, dynamic> map, String key, {String? defaultValue})` - Required string. Throws FormatException if missing (and no default) or wrong type.
2. `String? safeStringNullable(Map<String, dynamic> map, String key)` - Nullable string. Returns null if missing, throws if wrong type.
3. `int safeInt(Map<String, dynamic> map, String key, {int defaultValue = 0})` - Required int with default. Throws if wrong type (not null).
4. `int? safeIntNullable(Map<String, dynamic> map, String key)` - Nullable int.
5. `double safeDouble(Map<String, dynamic> map, String key, {double defaultValue = 0.0})` - Required double. Must handle both `int` and `double` input via `(value as num).toDouble()`.
6. `double? safeDoubleNullable(Map<String, dynamic> map, String key)` - Nullable double. Must handle both `int` and `double` input.
7. `bool safeBool(Map<String, dynamic> map, String key, {bool defaultValue = false})` - Required bool with default.
8. `bool? safeBoolNullable(Map<String, dynamic> map, String key)` - Nullable bool.
9. `num safeNum(Map<String, dynamic> map, String key, {num defaultValue = 0})` - Required num with default.
10. `num? safeNumNullable(Map<String, dynamic> map, String key)` - Nullable num.
11. `DateTime requireDateTime(Map<String, dynamic> map, String key)` - Required DateTime. Handle BOTH `DateTime` type (Supabase sometimes returns this) AND `String` type (parse via `DateTime.tryParse`). Throw FormatException if missing, unparseable, or wrong type.
12. `DateTime? safeDateTimeNullable(Map<String, dynamic> map, String key)` - Nullable DateTime. Same dual-type handling. Return null if key missing or value null.
13. `Map<String, dynamic> safeMap(Map<String, dynamic> map, String key)` - Required Map. Throws if missing or wrong type. Handles `Map<String, dynamic>` input.
14. `Map<String, dynamic>? safeMapNullable(Map<String, dynamic> map, String key)` - Nullable Map.
15. `List<dynamic> safeList(Map<String, dynamic> map, String key)` - Required List. Throws if missing or wrong type.
16. `List<dynamic>? safeListNullable(Map<String, dynamic> map, String key)` - Nullable List.

**Behavior rules:**
- All "required" helpers (without Nullable suffix) throw `FormatException('Missing required field: $key')` when key is missing/null AND no defaultValue
- All helpers throw `FormatException('Field $key must be TYPE, got ${value.runtimeType}')` on type mismatch
- `safeDouble` and `safeDoubleNullable` accept both `int` and `double` inputs (check `is num`)
- `requireDateTime` and `safeDateTimeNullable` accept both `DateTime` and `String` inputs
- `requireDateTime` throws `FormatException('Invalid DateTime format for $key: $value')` if string cannot be parsed

**TDD approach:**
1. Write test file first with test cases for each helper covering: valid input, null input, wrong type input, default value behavior
2. Run tests (RED - all fail since helpers don't exist)
3. Create `parsing_helpers.dart` with implementations
4. Run tests (GREEN - all pass)

File location: `backend/lib/helpers/parsing_helpers.dart` (alongside existing `collection_helpers.dart`)
Test location: `backend/test/helpers/parsing_helpers_test.dart`
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test test/helpers/parsing_helpers_test.dart` - all tests pass.
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze lib/helpers/parsing_helpers.dart` - no issues.
  </verify>
  <done>
All 16 parsing helper functions exist with unit tests covering valid input, null handling, type mismatch errors, and default values. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix LeaderboardEntry JSON key mismatch</name>
  <files>
    backend/lib/models/season.dart
    backend/test/models/season_test.dart
  </files>
  <action>
Fix the known LeaderboardEntry JSON key mismatch flagged in Phase 1:

In `backend/lib/models/season.dart`, find the `LeaderboardEntry.fromJson` factory method. The `optedOut` field reads from key `'leaderboard_opt_out'` but `toJson` writes to key `'opted_out'`.

**Change `fromJson` to read `'opted_out'`** (matching toJson), since `opted_out` is the canonical key used in the API response. Specifically change:
```dart
// FROM:
optedOut: row['leaderboard_opt_out'] as bool?,
// TO:
optedOut: row['opted_out'] as bool?,
```

**Important:** Also check if any service file writes to `leaderboard_opt_out` key - if so, that service should also be updated to use `opted_out`. Search with: `grep -rn 'leaderboard_opt_out' backend/lib/`

Then update the existing roundtrip test in `backend/test/models/season_test.dart`:
- The Phase 1 roundtrip test for LeaderboardEntry currently SKIPS the optedOut field check due to this mismatch
- Find the test and update it to include `optedOut` in the roundtrip assertion
- If the test currently excludes `opted_out` from the JSON map or skips the equality check, add it back

Do NOT yet migrate this file to use parsing_helpers.dart - that happens in Plan 02. Only fix the key mismatch here.
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test test/models/season_test.dart` - all tests pass including LeaderboardEntry roundtrip with optedOut.
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && grep -n 'leaderboard_opt_out' lib/` - should return zero results in models.
  </verify>
  <done>
LeaderboardEntry fromJson reads 'opted_out' matching toJson. Roundtrip test verifies optedOut field survives serialization. No key mismatch remains.
  </done>
</task>

</tasks>

<verification>
1. `dart test test/helpers/` passes with all parsing helper tests green
2. `dart test test/models/season_test.dart` passes with optedOut roundtrip
3. `dart analyze lib/helpers/parsing_helpers.dart` shows no issues
4. `parsing_helpers.dart` exports all 16 helper functions
</verification>

<success_criteria>
- parsing_helpers.dart exists with 16 safe extraction functions
- All parsing helpers have unit tests covering normal, null, and type-error cases
- LeaderboardEntry key mismatch fixed (fromJson and toJson both use 'opted_out')
- All existing backend tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-type-safety-validation/02-01-SUMMARY.md`
</output>
