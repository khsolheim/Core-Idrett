---
phase: "02-type-safety"
plan: "04"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - "backend/lib/api/auth_handler.dart"
  - "backend/lib/api/teams_handler.dart"
  - "backend/lib/api/team_settings_handler.dart"
  - "backend/lib/api/activities_handler.dart"
  - "backend/lib/api/activity_instances_handler.dart"
  - "backend/lib/api/fines_handler.dart"
  - "backend/lib/api/seasons_handler.dart"
  - "backend/lib/api/leaderboards_handler.dart"
  - "backend/lib/api/leaderboard_entries_handler.dart"
  - "backend/lib/api/messages_handler.dart"
  - "backend/lib/api/notifications_handler.dart"
  - "backend/lib/api/documents_handler.dart"
  - "backend/lib/api/absence_handler.dart"
  - "backend/lib/api/absence_categories_handler.dart"
  - "backend/lib/api/statistics_handler.dart"
  - "backend/lib/api/exports_handler.dart"
  - "backend/lib/api/tests_handler.dart"
  - "backend/lib/api/test_results_handler.dart"
  - "backend/lib/api/stopwatch_handler.dart"
  - "backend/lib/api/stopwatch_times_handler.dart"
  - "backend/lib/api/points_config_handler.dart"
  - "backend/lib/api/points_adjustments_handler.dart"
  - "backend/lib/api/tournaments_handler.dart"
  - "backend/lib/api/tournament_rounds_handler.dart"
  - "backend/lib/api/tournament_matches_handler.dart"
  - "backend/lib/api/tournament_groups_handler.dart"
  - "backend/lib/api/mini_activities_handler.dart"
  - "backend/lib/api/mini_activity_teams_handler.dart"
  - "backend/lib/api/mini_activity_scoring_handler.dart"
  - "backend/lib/api/mini_activity_statistics_handler.dart"
  - "backend/lib/api/achievements_handler.dart"
  - "backend/lib/api/achievement_awards_handler.dart"
autonomous: true

must_haves:
  truths:
    - "All handler files use safe parsing helpers for request body extraction"
    - "Zero unsafe as casts remain in any backend handler file"
    - "Backend dart analyze shows zero issues across entire lib directory"
    - "All existing backend tests pass after complete migration"
  artifacts:
    - path: "backend/lib/api/activities_handler.dart"
      provides: "Example handler with safe request parsing"
      contains: "import.*parsing_helpers"
    - path: "backend/lib/api/points_config_handler.dart"
      provides: "Heaviest handler migrated (55 casts)"
      contains: "safeString"
  key_links:
    - from: "backend/lib/api/*.dart"
      to: "backend/lib/helpers/parsing_helpers.dart"
      via: "import and usage for request body parsing"
      pattern: "safeString|safeInt|safeBool"
---

<objective>
Migrate all 32 backend handler files to use safe parsing helpers for request body extraction, eliminating all remaining unsafe `as` casts in the handler layer. Run final comprehensive verification across the entire backend.

Purpose: Handlers are the entry point where user input arrives. Safe parsing here prevents crashes from malformed client requests and provides clear error context.
Output: Zero unsafe casts remain in any backend handler. Full `dart analyze` clean.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-type-safety-validation/02-RESEARCH.md
@.planning/phases/02-type-safety-validation/02-01-SUMMARY.md
@backend/lib/helpers/parsing_helpers.dart
@backend/lib/api/helpers/validation_helpers.dart
@backend/lib/api/helpers/request_helpers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate handler files (auth through mini-activity)</name>
  <files>
    backend/lib/api/auth_handler.dart
    backend/lib/api/teams_handler.dart
    backend/lib/api/team_settings_handler.dart
    backend/lib/api/activities_handler.dart
    backend/lib/api/activity_instances_handler.dart
    backend/lib/api/fines_handler.dart
    backend/lib/api/seasons_handler.dart
    backend/lib/api/leaderboards_handler.dart
    backend/lib/api/leaderboard_entries_handler.dart
    backend/lib/api/messages_handler.dart
    backend/lib/api/notifications_handler.dart
    backend/lib/api/documents_handler.dart
    backend/lib/api/absence_handler.dart
    backend/lib/api/absence_categories_handler.dart
    backend/lib/api/statistics_handler.dart
    backend/lib/api/exports_handler.dart
  </files>
  <action>
For each handler file, add `import '../helpers/parsing_helpers.dart';` (or adjust relative path based on file location) and replace unsafe casts.

**Handler-specific patterns:**

Handlers typically parse request bodies via `parseBody(request)` which returns `Map<String, dynamic>`. The casts are on this body map:

1. **`data['key'] as String?`** -> `safeStringNullable(data, 'key')`
2. **`data['key'] as String`** -> `safeString(data, 'key')`
3. **`data['key'] as int?`** -> `safeIntNullable(data, 'key')`
4. **`data['key'] as int`** -> `safeInt(data, 'key')`
5. **`data['key'] as bool?`** -> `safeBoolNullable(data, 'key')`
6. **`data['key'] as bool? ?? false`** -> `safeBool(data, 'key', defaultValue: false)`
7. **`data['key'] as num? ?? 0`** -> `safeNum(data, 'key', defaultValue: 0)` or `safeInt(data, 'key', defaultValue: 0)` as appropriate
8. **`data['key'] as Map<String, dynamic>?`** -> `safeMapNullable(data, 'key')`
9. **`data['key'] as List?`** or **`data['key'] as List<dynamic>?`** -> `safeListNullable(data, 'key')`
10. **`(data['key'] as num?)?.toDouble()`** -> `safeDoubleNullable(data, 'key')`
11. **`(data['key'] as num).toDouble()`** -> `safeDouble(data, 'key')`

**Important: Coexistence with validation_helpers.dart**

Some handlers already use `requireString()`, `requirePositiveInt()`, `requireEnum()`, etc. from `validation_helpers.dart` for required request fields. These are INPUT VALIDATION helpers (they throw BadRequestException for user-facing errors). **Keep these where they're already used** -- they serve a different purpose (validating user input vs. safely parsing data).

Only replace raw `as Type` casts that are NOT already wrapped by validation helpers.

For example, if a handler does:
```dart
final title = requireString(data, 'title'); // Keep - already validated
final location = data['location'] as String?; // Replace with safeStringNullable
```

**Handlers in this task (16 files):**
- auth_handler.dart (~13 casts)
- teams_handler.dart (~10 casts)
- team_settings_handler.dart (~8 casts)
- activities_handler.dart (~16 casts)
- activity_instances_handler.dart (~26 casts)
- fines_handler.dart (~8 casts)
- seasons_handler.dart (~11 casts)
- leaderboards_handler.dart (~10 casts)
- leaderboard_entries_handler.dart (~11 casts)
- messages_handler.dart (~6 casts)
- notifications_handler.dart (~11 casts)
- documents_handler.dart (~16 casts)
- absence_handler.dart (~6 casts)
- absence_categories_handler.dart (~12 casts)
- statistics_handler.dart (~2 casts)
- exports_handler.dart (~1 cast)
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze lib/api/auth_handler.dart lib/api/teams_handler.dart lib/api/activities_handler.dart lib/api/fines_handler.dart` - no issues (spot check).
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test` - all tests pass.
  </verify>
  <done>
All 16 handler files migrated. Zero unsafe casts remain in auth, team, activity, fine, season, leaderboard, message, notification, document, absence, statistics, and export handlers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate remaining handlers + final full-codebase verification</name>
  <files>
    backend/lib/api/tests_handler.dart
    backend/lib/api/test_results_handler.dart
    backend/lib/api/stopwatch_handler.dart
    backend/lib/api/stopwatch_times_handler.dart
    backend/lib/api/points_config_handler.dart
    backend/lib/api/points_adjustments_handler.dart
    backend/lib/api/tournaments_handler.dart
    backend/lib/api/tournament_rounds_handler.dart
    backend/lib/api/tournament_matches_handler.dart
    backend/lib/api/tournament_groups_handler.dart
    backend/lib/api/mini_activities_handler.dart
    backend/lib/api/mini_activity_teams_handler.dart
    backend/lib/api/mini_activity_scoring_handler.dart
    backend/lib/api/mini_activity_statistics_handler.dart
    backend/lib/api/achievements_handler.dart
    backend/lib/api/achievement_awards_handler.dart
  </files>
  <action>
**Part A: Migrate remaining 16 handler files**

Apply the same replacement rules from Task 1. These are the remaining handlers:

- tests_handler.dart (~9 casts)
- test_results_handler.dart (~7 casts)
- stopwatch_handler.dart (~6 casts)
- stopwatch_times_handler.dart (~14 casts)
- points_config_handler.dart (~55 casts -- largest handler!)
- points_adjustments_handler.dart (~6 casts)
- tournaments_handler.dart (~10 casts)
- tournament_rounds_handler.dart (~8 casts)
- tournament_matches_handler.dart (~16 casts)
- tournament_groups_handler.dart (~22 casts)
- mini_activities_handler.dart (~34 casts)
- mini_activity_teams_handler.dart (~13 casts)
- mini_activity_scoring_handler.dart (~12 casts)
- mini_activity_statistics_handler.dart (~4 casts)
- achievements_handler.dart (~25 casts)
- achievement_awards_handler.dart (~7 casts)

**Part B: Full codebase verification**

After all handlers are migrated, run comprehensive verification:

1. `dart analyze lib/` - must show zero issues
2. `dart test` - all tests must pass
3. Count remaining unsafe casts: `grep -rn ' as String\b\| as int\b\| as bool\b\| as num\b\| as Map\| as List\| as double\b\| as DateTime\b' lib/ | grep -v 'test/\|\.g\.dart\|// \|toString\|toJson\|as String);\|is String\|is int\|is bool\|is num\|is Map\|is List\|is double\|is DateTime'`
   - Any remaining casts should be ONLY in: response helpers (creating Response objects), middleware, or intentional casts on known types
4. Count remaining DateTime.parse: `grep -rn 'DateTime\.parse(' lib/` - should be zero
5. Count remaining unguarded .first: verify all `.first[` or `.first;` have isEmpty guards above them
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze lib/` - zero issues.
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test` - all tests pass.
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && grep -rn 'DateTime\.parse(' lib/` - zero results.
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && grep -rn ' as String[^?]' lib/models/ lib/services/ | grep -v 'toString\|toJson\|// ' | wc -l` - zero.
  </verify>
  <done>
All 32 handler files migrated. Full backend codebase verified: zero unsafe casts in models/services/handlers, zero DateTime.parse() calls, all .first accesses guarded, dart analyze clean, all tests passing.
  </done>
</task>

</tasks>

<verification>
1. `dart analyze lib/` - zero issues across entire backend
2. `dart test` - all tests pass (339+ model tests + any others)
3. `grep -rn 'DateTime\.parse(' lib/` - zero results
4. Unsafe cast audit across models, services, and handlers shows zero remaining
5. All files with fromJson or DB result access import parsing_helpers.dart
</verification>

<success_criteria>
- All 32 handler files use safe parsing helpers
- Zero unsafe casts remain in models, services, or handlers
- Zero DateTime.parse() calls remain anywhere in backend lib/
- All .first accesses guarded with emptiness checks
- dart analyze lib/ shows zero issues
- All existing tests pass
- Phase 2 success criteria met:
  1. Zero unsafe `as String`, `as int`, `as Map` casts
  2. All JSON deserialization uses validation helpers
  3. All DateTime parsing uses tryParse with fallback
  4. All query result access checks emptiness or uses firstOrNull
  5. Backend analyze shows zero type safety warnings
</success_criteria>

<output>
After completion, create `.planning/phases/02-type-safety-validation/02-04-SUMMARY.md`
</output>
