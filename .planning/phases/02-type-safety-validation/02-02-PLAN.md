---
phase: "02-type-safety"
plan: "02"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - "backend/lib/models/user.dart"
  - "backend/lib/models/team.dart"
  - "backend/lib/models/activity.dart"
  - "backend/lib/models/message.dart"
  - "backend/lib/models/document.dart"
  - "backend/lib/models/notification.dart"
  - "backend/lib/models/export_log.dart"
  - "backend/lib/models/fine.dart"
  - "backend/lib/models/absence.dart"
  - "backend/lib/models/test.dart"
  - "backend/lib/models/season.dart"
  - "backend/lib/models/stopwatch.dart"
  - "backend/lib/models/points_config.dart"
  - "backend/lib/models/statistics.dart"
  - "backend/lib/models/mini_activity_core.dart"
  - "backend/lib/models/mini_activity_team.dart"
  - "backend/lib/models/mini_activity_adjustment.dart"
  - "backend/lib/models/mini_activity_statistics.dart"
  - "backend/lib/models/tournament_core.dart"
  - "backend/lib/models/tournament_round.dart"
  - "backend/lib/models/tournament_match.dart"
  - "backend/lib/models/tournament_group.dart"
  - "backend/lib/models/achievement_definition.dart"
  - "backend/lib/models/achievement_user.dart"
autonomous: true

must_haves:
  truths:
    - "All backend model fromJson methods use safe parsing helpers instead of unsafe casts"
    - "All DateTime.parse() in models replaced with requireDateTime or safeDateTimeNullable"
    - "All (value as num).toDouble() patterns replaced with safeDouble or safeDoubleNullable"
    - "Existing model roundtrip tests still pass after migration"
  artifacts:
    - path: "backend/lib/models/activity.dart"
      provides: "Example of migrated model"
      contains: "import.*parsing_helpers"
    - path: "backend/lib/models/fine.dart"
      provides: "Example with DateTime.parse replaced"
      contains: "requireDateTime"
  key_links:
    - from: "backend/lib/models/*.dart"
      to: "backend/lib/helpers/parsing_helpers.dart"
      via: "import and usage in fromJson"
      pattern: "safeString|safeInt|requireDateTime"
---

<objective>
Migrate all 24 backend model files to use safe parsing helpers from `parsing_helpers.dart` in their `fromJson` factory methods, eliminating all unsafe `as` casts and `DateTime.parse()` calls in the model layer.

Purpose: Models are the primary deserialization boundary. Safe parsing here catches bad data at the earliest possible point and provides descriptive error messages.
Output: All model `fromJson` methods use safe extraction functions. Zero unsafe casts remain in `backend/lib/models/`.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-type-safety-validation/02-RESEARCH.md
@.planning/phases/02-type-safety-validation/02-01-SUMMARY.md
@backend/lib/helpers/parsing_helpers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate core and communication model files</name>
  <files>
    backend/lib/models/user.dart
    backend/lib/models/team.dart
    backend/lib/models/activity.dart
    backend/lib/models/message.dart
    backend/lib/models/document.dart
    backend/lib/models/notification.dart
    backend/lib/models/export_log.dart
    backend/lib/models/fine.dart
    backend/lib/models/absence.dart
    backend/lib/models/test.dart
    backend/lib/models/season.dart
    backend/lib/models/stopwatch.dart
  </files>
  <action>
For each model file listed, add `import '../helpers/parsing_helpers.dart';` and replace all unsafe casts in `fromJson` factory methods.

**Replacement rules (apply mechanically):**

1. **`row['key'] as String`** -> `safeString(row, 'key')`
2. **`row['key'] as String?`** -> `safeStringNullable(row, 'key')`
3. **`row['key'] as String? ?? 'default'`** -> `safeString(row, 'key', defaultValue: 'default')`
4. **`row['key'] as int`** -> `safeInt(row, 'key')`
5. **`row['key'] as int?`** -> `safeIntNullable(row, 'key')`
6. **`row['key'] as int? ?? 0`** -> `safeInt(row, 'key', defaultValue: 0)` (or appropriate default)
7. **`(row['key'] as num).toDouble()`** -> `safeDouble(row, 'key')`
8. **`row['key'] != null ? (row['key'] as num).toDouble() : null`** -> `safeDoubleNullable(row, 'key')`
9. **`row['key'] as bool`** -> `safeBool(row, 'key')`
10. **`row['key'] as bool?`** -> `safeBoolNullable(row, 'key')`
11. **`row['key'] as bool? ?? false`** or **`row['key'] ?? false`** (when used for bool) -> `safeBool(row, 'key', defaultValue: false)`
12. **`row['key'] as DateTime`** -> `requireDateTime(row, 'key')`
13. **`row['key'] as DateTime?`** -> `safeDateTimeNullable(row, 'key')`
14. **`DateTime.parse(row['key'])`** -> `requireDateTime(row, 'key')`
15. **`row['key'] != null ? DateTime.parse(row['key']) : null`** -> `safeDateTimeNullable(row, 'key')`
16. **`DateTime.tryParse(row['key'])`** (already safe but standalone) -> Keep as-is if operating on already-extracted string, OR use `safeDateTimeNullable(row, 'key')` if extracting from map
17. **`row['key'] as Map<String, dynamic>`** -> `safeMap(row, 'key')`
18. **`row['key'] as List`** -> `safeList(row, 'key')`

**Special patterns in fine.dart:**
- `json['id']` without any cast (dynamic access) where field type is String -> `safeString(json, 'id')`
- `json['status'] ?? 'pending'` where type should be String -> `safeString(json, 'status', defaultValue: 'pending')`
- `json['is_game_day'] ?? false` where type should be bool -> `safeBool(json, 'is_game_day', defaultValue: false)`
- `json['active'] ?? true` where type should be bool -> `safeBool(json, 'active', defaultValue: true)`

**Do NOT change:**
- `toJson()` methods (these output, not input)
- Constructor signatures
- Equatable props
- Any non-fromJson code
- Nested model parsing like `FineAppeal.fromJson(json['appeal'])` -- keep the `fromJson` call, but ensure the map extraction is safe: `json['appeal'] != null ? FineAppeal.fromJson(safeMap(json, 'appeal')) : null`

**Files in this task (12 files):**
- user.dart (1 class, ~4 casts)
- team.dart (3 classes, ~22 casts)
- activity.dart (3 classes, ~23 casts)
- message.dart (1 class, ~14 casts)
- document.dart (1 class, ~14 casts)
- notification.dart (2 classes, ~16 casts)
- export_log.dart (1 class, ~8 casts)
- fine.dart (5 classes, ~5 explicit casts + many untyped accesses + 6 DateTime.parse)
- absence.dart (2 classes, ~28 casts + 5 DateTime.parse)
- test.dart (2 classes, ~18 casts + 2 DateTime.parse)
- season.dart (4 classes, ~37 casts + 5 DateTime.parse)
- stopwatch.dart (3 classes, ~23 casts)
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test test/models/` - all 191 existing roundtrip tests pass.
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze lib/models/user.dart lib/models/team.dart lib/models/activity.dart lib/models/message.dart lib/models/document.dart lib/models/notification.dart lib/models/export_log.dart lib/models/fine.dart lib/models/absence.dart lib/models/test.dart lib/models/season.dart lib/models/stopwatch.dart` - no issues.
Run `grep -c ' as ' lib/models/user.dart lib/models/team.dart lib/models/activity.dart lib/models/message.dart lib/models/document.dart lib/models/notification.dart lib/models/export_log.dart lib/models/fine.dart lib/models/absence.dart lib/models/test.dart lib/models/season.dart lib/models/stopwatch.dart` - all show 0 (or only in toJson/non-fromJson code).
  </verify>
  <done>
All 12 model files migrated to safe parsing helpers. Zero unsafe casts remain in fromJson methods. All 191 roundtrip tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate mini-activity, tournament, achievement, statistics, and points model files</name>
  <files>
    backend/lib/models/points_config.dart
    backend/lib/models/statistics.dart
    backend/lib/models/mini_activity_core.dart
    backend/lib/models/mini_activity_team.dart
    backend/lib/models/mini_activity_adjustment.dart
    backend/lib/models/mini_activity_statistics.dart
    backend/lib/models/tournament_core.dart
    backend/lib/models/tournament_round.dart
    backend/lib/models/tournament_match.dart
    backend/lib/models/tournament_group.dart
    backend/lib/models/achievement_definition.dart
    backend/lib/models/achievement_user.dart
  </files>
  <action>
Apply the EXACT SAME replacement rules from Task 1 to the remaining 12 model files. Add `import '../helpers/parsing_helpers.dart';` to each file.

**Files in this task (12 files):**
- points_config.dart (3 classes, ~37 casts + 4 DateTime.parse)
- statistics.dart (6 classes, ~1 explicit cast - mostly constructed by services, not fromJson)
- mini_activity_core.dart (2 classes, ~32 casts + 2 DateTime.parse)
- mini_activity_team.dart (2 classes, ~9 casts)
- mini_activity_adjustment.dart (2 classes, ~12 casts + 1 DateTime.parse)
- mini_activity_statistics.dart (5 classes, ~44 casts)
- tournament_core.dart (1 class, ~9 casts)
- tournament_round.dart (1 class, ~8 casts)
- tournament_match.dart (2 classes, ~25 casts)
- tournament_group.dart (5 classes, ~41 casts)
- achievement_definition.dart (2 classes, ~21 casts + 2 DateTime.parse)
- achievement_user.dart (2 classes, ~32 casts + 4 DateTime.parse)

**Same rules apply:**
- Replace all `as Type` in fromJson with safe helpers
- Replace all `DateTime.parse()` with requireDateTime/safeDateTimeNullable
- Replace all `(x as num).toDouble()` with safeDouble/safeDoubleNullable
- Do NOT change toJson, constructors, props, or non-fromJson code
- Handle nested fromJson calls by ensuring map extraction is safe

**Note for statistics.dart:** Some classes may only have `toJson` and be constructed directly by services (like `MatchStats`, `PlayerRating`). If a class has no `fromJson`, skip it. Only migrate classes that actually have `fromJson` factories.
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test test/models/` - all 191 existing roundtrip tests pass.
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze lib/models/` - no issues.
Run: `grep -rn ' as String\| as int\| as bool\| as num\| as Map\| as List\| as DateTime\| as double\|DateTime\.parse(' lib/models/ | grep -v '_test\|toJson\|// ' | wc -l` - should be 0 or very close to 0 (only remaining casts should be in toJson or comments).
  </verify>
  <done>
All 24 model files migrated. Zero unsafe casts and zero DateTime.parse() calls remain in any backend model fromJson method. All roundtrip tests pass unchanged.
  </done>
</task>

</tasks>

<verification>
1. `dart test test/models/` - all 191 tests pass
2. `dart analyze lib/models/` - no issues
3. `grep -rn 'DateTime\.parse(' lib/models/` returns zero results
4. Every model file with a fromJson imports parsing_helpers.dart
5. Zero `as String`, `as int`, `as bool`, `as DateTime` casts remain in fromJson methods
</verification>

<success_criteria>
- All 24 model files use safe parsing helpers in fromJson
- Zero unsafe casts remain in model deserialization code
- Zero DateTime.parse() calls remain in models
- All 191 existing roundtrip tests pass without modification
- dart analyze shows no issues in models/
</success_criteria>

<output>
After completion, create `.planning/phases/02-type-safety-validation/02-02-SUMMARY.md`
</output>
