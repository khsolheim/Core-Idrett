---
phase: "02-type-safety"
plan: "03"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - "backend/lib/services/auth_service.dart"
  - "backend/lib/services/user_service.dart"
  - "backend/lib/services/team_service.dart"
  - "backend/lib/services/team_member_service.dart"
  - "backend/lib/services/activity_service.dart"
  - "backend/lib/services/activity_instance_service.dart"
  - "backend/lib/services/fine_service.dart"
  - "backend/lib/services/season_service.dart"
  - "backend/lib/services/leaderboard_service.dart"
  - "backend/lib/services/leaderboard_entry_service.dart"
  - "backend/lib/services/message_service.dart"
  - "backend/lib/services/direct_message_service.dart"
  - "backend/lib/services/team_chat_service.dart"
  - "backend/lib/services/notification_service.dart"
  - "backend/lib/services/document_service.dart"
  - "backend/lib/services/absence_service.dart"
  - "backend/lib/services/statistics_service.dart"
  - "backend/lib/services/dashboard_service.dart"
  - "backend/lib/services/export_service.dart"
  - "backend/lib/services/test_service.dart"
  - "backend/lib/services/stopwatch_service.dart"
  - "backend/lib/services/player_rating_service.dart"
  - "backend/lib/services/match_stats_service.dart"
  - "backend/lib/services/points_config_service.dart"
  - "backend/lib/services/tournament_service.dart"
  - "backend/lib/services/tournament_group_service.dart"
  - "backend/lib/services/mini_activity_service.dart"
  - "backend/lib/services/mini_activity_result_service.dart"
  - "backend/lib/services/mini_activity_template_service.dart"
  - "backend/lib/services/mini_activity_division_service.dart"
  - "backend/lib/services/mini_activity_statistics_service.dart"
  - "backend/lib/services/achievement_service.dart"
  - "backend/lib/services/achievement_definition_service.dart"
  - "backend/lib/services/achievement_progress_service.dart"
  - "backend/lib/helpers/collection_helpers.dart"
autonomous: true

must_haves:
  truths:
    - "All service files use safe parsing helpers for database result extraction"
    - "All .first accesses on query results are guarded with emptiness checks or firstOrNull"
    - "All DateTime.parse() in services replaced with tryParse or parsing helpers"
    - "collection_helpers.dart uses safeString instead of as String"
  artifacts:
    - path: "backend/lib/services/auth_service.dart"
      provides: "Example service with safe casts"
      contains: "import.*parsing_helpers"
    - path: "backend/lib/services/fine_service.dart"
      provides: "Example with .first guarded"
      contains: "safeString"
  key_links:
    - from: "backend/lib/services/*.dart"
      to: "backend/lib/helpers/parsing_helpers.dart"
      via: "import and usage for DB result parsing"
      pattern: "safeString|safeInt|requireDateTime"
---

<objective>
Migrate all 34 backend service files to use safe parsing helpers for database result extraction, guard all `.first` accesses on query results, and replace all remaining `DateTime.parse()` calls with safe alternatives. Also update `collection_helpers.dart`.

Purpose: Services are the secondary deserialization boundary where raw database rows are accessed. Safe parsing here prevents runtime crashes from unexpected null or wrong-type database values.
Output: Zero unsafe casts, zero unguarded `.first` accesses, zero `DateTime.parse()` calls in backend services.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-type-safety-validation/02-RESEARCH.md
@.planning/phases/02-type-safety-validation/02-01-SUMMARY.md
@backend/lib/helpers/parsing_helpers.dart
@backend/lib/helpers/collection_helpers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate core services (auth, user, team, activity, fine, season, leaderboard, message)</name>
  <files>
    backend/lib/services/auth_service.dart
    backend/lib/services/user_service.dart
    backend/lib/services/team_service.dart
    backend/lib/services/team_member_service.dart
    backend/lib/services/activity_service.dart
    backend/lib/services/activity_instance_service.dart
    backend/lib/services/fine_service.dart
    backend/lib/services/season_service.dart
    backend/lib/services/leaderboard_service.dart
    backend/lib/services/leaderboard_entry_service.dart
    backend/lib/services/message_service.dart
    backend/lib/services/direct_message_service.dart
    backend/lib/services/team_chat_service.dart
    backend/lib/services/notification_service.dart
    backend/lib/services/document_service.dart
    backend/lib/services/absence_service.dart
    backend/lib/services/statistics_service.dart
    backend/lib/services/dashboard_service.dart
    backend/lib/helpers/collection_helpers.dart
  </files>
  <action>
For each service file, add `import '../helpers/parsing_helpers.dart';` and apply these changes:

**1. Replace unsafe casts on database row access:**

Services read from `List<Map<String, dynamic>>` query results. Apply the same replacement rules as model migration:
- `row['key'] as String` -> `safeString(row, 'key')`
- `row['key'] as String?` -> `safeStringNullable(row, 'key')`
- `row['key'] as int` -> `safeInt(row, 'key')`
- `row['key'] as int? ?? 0` -> `safeInt(row, 'key', defaultValue: 0)`
- `(row['key'] as num).toDouble()` -> `safeDouble(row, 'key')`
- `row['key'] as bool` -> `safeBool(row, 'key')`
- `row['key'] as bool?` -> `safeBoolNullable(row, 'key')`
- `row['key'] as Map<String, dynamic>` -> `safeMap(row, 'key')`
- `DateTime.parse(row['key'] as String)` -> `requireDateTime(row, 'key')` (when required)
- `DateTime.parse(row['key'])` -> `requireDateTime(row, 'key')`
- `row['key'] != null ? DateTime.parse(row['key']) : null` -> `safeDateTimeNullable(row, 'key')`

**Important exception for DateTime:** When a service does `DateTime.parse(someVariable)` where `someVariable` is already an extracted String (not a map access), use `DateTime.tryParse(someVariable)` instead of the map-based helper. For example:
```dart
// BEFORE: DateTime.parse(someStringVar)
// AFTER: DateTime.tryParse(someStringVar) ?? DateTime.now() // or handle null appropriately
```

**2. Guard .first accesses:**

Pattern: `result.first['key']` is unsafe if `result` could be empty.

For each `.first[` usage, check if there's already an `isEmpty` guard above it. If YES, leave it. If NO, add one:
```dart
// BEFORE (no guard):
final teamId = result.first['team_id'] as String;

// AFTER (with guard):
if (result.isEmpty) return null; // or throw, depending on method semantics
final teamId = safeString(result.first, 'team_id');
```

For `.first;` (not accessing a key), same guard logic applies.

**Note on existing firstOrNull usage:** A few files already use `firstOrNull` (leaderboards_handler.dart, activity_service.dart). Leave those as-is -- they're already safe.

**3. Update collection_helpers.dart:**
In `collection_helpers.dart`, the `groupByCount` and `groupBy` functions use `item[key] as String`. Replace with `safeString(item, key)` and add the import.

**Services in this task (18 services + collection_helpers):**
- auth_service.dart (~25 casts, 4 DateTime.parse)
- user_service.dart (~1 cast)
- team_service.dart (~17 casts, 1 DateTime.parse)
- team_member_service.dart (~18 casts, 2 DateTime.parse)
- activity_service.dart (~17 casts)
- activity_instance_service.dart (~14 casts, 2 DateTime.parse)
- fine_service.dart (~28 casts)
- season_service.dart (~3 casts)
- leaderboard_service.dart (~34 casts)
- leaderboard_entry_service.dart (~13 casts, 1 DateTime.parse)
- message_service.dart (~23 casts, 5 DateTime.parse)
- direct_message_service.dart (~4 casts, 2 DateTime.parse)
- team_chat_service.dart (~3 casts)
- notification_service.dart (~7 casts)
- document_service.dart (~4 casts)
- absence_service.dart (~5 casts)
- statistics_service.dart (~25 casts)
- dashboard_service.dart (~4 casts)
- collection_helpers.dart (2 casts)
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze lib/services/ lib/helpers/` - no issues.
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test` - all tests pass.
Run `grep -c ' as String\| as int\| as bool\| as num\| as Map\| as List\| as double' lib/services/auth_service.dart lib/services/fine_service.dart lib/services/leaderboard_service.dart` - all show 0 (spot check).
  </verify>
  <done>
All 18 core service files and collection_helpers.dart migrated to safe parsing helpers. All .first accesses guarded. All DateTime.parse replaced.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate remaining services (export, test, stopwatch, tournament, mini-activity, achievement, points)</name>
  <files>
    backend/lib/services/export_service.dart
    backend/lib/services/test_service.dart
    backend/lib/services/stopwatch_service.dart
    backend/lib/services/player_rating_service.dart
    backend/lib/services/match_stats_service.dart
    backend/lib/services/points_config_service.dart
    backend/lib/services/tournament_service.dart
    backend/lib/services/tournament_group_service.dart
    backend/lib/services/mini_activity_service.dart
    backend/lib/services/mini_activity_result_service.dart
    backend/lib/services/mini_activity_template_service.dart
    backend/lib/services/mini_activity_division_service.dart
    backend/lib/services/mini_activity_statistics_service.dart
    backend/lib/services/achievement_service.dart
    backend/lib/services/achievement_definition_service.dart
    backend/lib/services/achievement_progress_service.dart
  </files>
  <action>
Apply the EXACT SAME replacement rules from Task 1 to the remaining 16 service files.

**Services in this task (16 files):**
- export_service.dart (~27 casts)
- test_service.dart (~41 casts, 4 DateTime.parse)
- stopwatch_service.dart (~6 casts)
- player_rating_service.dart (~9 casts)
- match_stats_service.dart (~4 casts)
- points_config_service.dart (~6 casts, 1 DateTime.parse)
- tournament_service.dart (~4 casts)
- tournament_group_service.dart (~13 casts)
- mini_activity_service.dart (~10 casts)
- mini_activity_result_service.dart (~26 casts)
- mini_activity_template_service.dart (~2 casts)
- mini_activity_division_service.dart (~6 casts)
- mini_activity_statistics_service.dart (~11 casts)
- achievement_service.dart (~1 cast)
- achievement_definition_service.dart (~1 cast)
- achievement_progress_service.dart (~18 casts)

**Same rules:**
1. Replace all `as Type` with safe helpers
2. Replace all `DateTime.parse()` with safe alternatives
3. Guard all unguarded `.first` accesses
4. Add `import '../helpers/parsing_helpers.dart';` to each file
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze lib/services/` - no issues.
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test` - all tests pass.
Run: `grep -rn 'DateTime\.parse(' lib/services/` - should return zero results.
Run: `grep -rn ' as String\b' lib/services/*.dart | grep -v '// \|toString()' | wc -l` - should be 0 or very close to 0.
  </verify>
  <done>
All 34 service files migrated. Zero unsafe casts, zero unguarded .first accesses, zero DateTime.parse() calls remain in backend services.
  </done>
</task>

</tasks>

<verification>
1. `dart analyze lib/services/ lib/helpers/` - no issues
2. `dart test` - all tests pass (model roundtrips + any service tests)
3. `grep -rn 'DateTime\.parse(' lib/services/` returns zero results
4. `grep -rn ' as String\b' lib/services/ | grep -v toString | wc -l` near zero
5. All service files import parsing_helpers.dart
</verification>

<success_criteria>
- All 34 service files use safe parsing helpers
- All .first accesses on query results are guarded
- Zero DateTime.parse() calls remain in services
- Zero unsafe casts remain in service DB result extraction
- collection_helpers.dart updated
- dart analyze shows no issues
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-type-safety-validation/02-03-SUMMARY.md`
</output>
