---
phase: 04-backend-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pubspec.yaml
  - backend/lib/api/middleware/rate_limit_middleware.dart
  - backend/lib/api/router.dart
autonomous: true

must_haves:
  truths:
    - "Auth endpoints (login, register, invite) are rate limited to prevent brute force"
    - "Message send and fine create endpoints are rate limited to prevent abuse"
    - "Export endpoints are rate limited with conservative limits"
    - "Rate limiter returns 429 when limit exceeded"
    - "Health check endpoint is NOT rate limited"
  artifacts:
    - path: "backend/lib/api/middleware/rate_limit_middleware.dart"
      provides: "Rate limiter configurations for auth, mutation, and export endpoints"
      exports: ["authRateLimiter", "mutationRateLimiter", "exportRateLimiter"]
    - path: "backend/lib/api/router.dart"
      provides: "Router with rate limiters applied to auth, messages, fines, and exports routes"
      contains: "authRateLimiter"
    - path: "backend/pubspec.yaml"
      provides: "shelf_limiter dependency"
      contains: "shelf_limiter"
  key_links:
    - from: "backend/lib/api/router.dart"
      to: "backend/lib/api/middleware/rate_limit_middleware.dart"
      via: "import and middleware application in Pipeline"
      pattern: "addMiddleware\\(authRateLimiter\\)"
    - from: "backend/lib/api/middleware/rate_limit_middleware.dart"
      to: "shelf_limiter"
      via: "package import"
      pattern: "package:shelf_limiter"
---

<objective>
Add rate limiting middleware to auth, data mutation, and export endpoints.

Purpose: Prevent brute-force attacks on authentication, abuse of message/fine creation, and excessive resource consumption from exports. Rate limiting is the most impactful security improvement for a public-facing API.

Output: shelf_limiter dependency added, rate_limit_middleware.dart with 3 limiter configurations, router.dart updated with rate limiters on auth, messages, fines, and exports routes.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-backend-security-input-validation/04-RESEARCH.md

@backend/pubspec.yaml
@backend/lib/api/router.dart
@backend/lib/api/middleware/auth_middleware.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shelf_limiter dependency and create rate limit middleware</name>
  <files>
    backend/pubspec.yaml
    backend/lib/api/middleware/rate_limit_middleware.dart
  </files>
  <action>
1. Add `shelf_limiter` to backend/pubspec.yaml dependencies:
```yaml
dependencies:
  shelf: ^1.4.2
  shelf_router: ^1.1.4
  shelf_limiter: ^2.0.1    # <-- ADD THIS
  http: ^1.2.0
  ...
```

2. Run `cd backend && dart pub get` to install.

3. Create `backend/lib/api/middleware/rate_limit_middleware.dart`:

```dart
import 'package:shelf_limiter/shelf_limiter.dart';

/// Rate limiter for auth endpoints (login, register).
/// Strict limits to prevent brute-force attacks.
/// 5 requests per minute per IP.
final authRateLimiter = shelfLimiter(
  RateLimiterOptions(
    maxRequests: 5,
    windowSize: const Duration(minutes: 1),
  ),
);

/// Rate limiter for data mutation endpoints (messages, fines).
/// Moderate limits to prevent abuse.
/// 30 requests per minute per IP.
final mutationRateLimiter = shelfLimiter(
  RateLimiterOptions(
    maxRequests: 30,
    windowSize: const Duration(minutes: 1),
  ),
);

/// Rate limiter for export endpoints.
/// Conservative limits since exports are resource-intensive.
/// 5 requests per 5 minutes per IP.
final exportRateLimiter = shelfLimiter(
  RateLimiterOptions(
    maxRequests: 5,
    windowSize: const Duration(minutes: 5),
  ),
);
```

Note: Using 30 (not 20) for mutation limiter since legitimate usage can involve rapid message sending in team chat. The auth limiter at 5/min is strict enough for brute-force prevention while allowing normal usage.
  </action>
  <verify>
Run `cd backend && dart pub get` — should succeed with shelf_limiter resolved.
Run `cd backend && dart analyze` — zero errors.
Verify the file exists: `cat backend/lib/api/middleware/rate_limit_middleware.dart`
  </verify>
  <done>
shelf_limiter ^2.0.1 added as dependency. rate_limit_middleware.dart exists with authRateLimiter (5/min), mutationRateLimiter (30/min), and exportRateLimiter (5/5min). `dart pub get` succeeds and `dart analyze` is clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply rate limiters to routes in router.dart</name>
  <files>
    backend/lib/api/router.dart
  </files>
  <action>
In `backend/lib/api/router.dart`:

1. Add import for rate limit middleware:
```dart
import 'middleware/rate_limit_middleware.dart';
```

2. Update the auth route to include rate limiting. Auth routes currently have NO middleware:

BEFORE:
```dart
final authHandler = AuthHandler(authService);
router.mount('/auth', authHandler.router.call);
```

AFTER:
```dart
final authHandler = AuthHandler(authService);
router.mount('/auth',
  const Pipeline()
    .addMiddleware(authRateLimiter)
    .addHandler(authHandler.router.call)
    .call
);
```

IMPORTANT: Auth routes get rate limiting BEFORE/WITHOUT auth middleware, since auth endpoints are unauthenticated.

3. Update the messages route to include mutation rate limiting. Messages already have auth middleware:

BEFORE:
```dart
router.mount('/messages', const Pipeline().addMiddleware(auth).addHandler(messagesHandler.router.call).call);
```

AFTER:
```dart
router.mount('/messages', const Pipeline().addMiddleware(auth).addMiddleware(mutationRateLimiter).addHandler(messagesHandler.router.call).call);
```

4. Update the fines route to include mutation rate limiting:

BEFORE:
```dart
router.mount('/fines', const Pipeline().addMiddleware(auth).addHandler(finesHandler.router.call).call);
```

AFTER:
```dart
router.mount('/fines', const Pipeline().addMiddleware(auth).addMiddleware(mutationRateLimiter).addHandler(finesHandler.router.call).call);
```

5. Update the exports route to include export rate limiting:

BEFORE:
```dart
router.mount('/exports', const Pipeline().addMiddleware(auth).addHandler(exportsHandler.router.call).call);
```

AFTER:
```dart
router.mount('/exports', const Pipeline().addMiddleware(auth).addMiddleware(exportRateLimiter).addHandler(exportsHandler.router.call).call);
```

6. Do NOT add rate limiting to: health check, teams, activities, mini-activities, tournaments, statistics, seasons, leaderboards, points, absence, achievements, tests, notifications, documents, stopwatch — these are read-heavy with legitimate high-frequency usage.

Pipeline order for protected routes: auth first (validates token), then rate limiter (tracks by IP), then handler.
Pipeline order for auth routes: rate limiter first (no auth needed), then handler.
  </action>
  <verify>
Run `cd backend && dart analyze` — zero errors.
Run `cd backend && dart test` — all 268 tests pass.
Grep for `authRateLimiter` in router.dart to confirm it appears.
Grep for `mutationRateLimiter` in router.dart to confirm it appears (should appear 2x: messages, fines).
Grep for `exportRateLimiter` in router.dart to confirm it appears (should appear 1x: exports).
  </verify>
  <done>
Auth routes rate limited with authRateLimiter (5/min). Messages and fines routes rate limited with mutationRateLimiter (30/min). Export routes rate limited with exportRateLimiter (5/5min). All tests pass. Health check and other routes unaffected.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && dart pub get` — shelf_limiter resolves successfully
2. `cd backend && dart analyze` — zero errors
3. `cd backend && dart test` — all 268 tests pass
4. `grep -n 'shelf_limiter' backend/pubspec.yaml` — dependency present
5. `grep -n 'authRateLimiter\|mutationRateLimiter\|exportRateLimiter' backend/lib/api/router.dart` — all 3 limiters referenced
6. `cat backend/lib/api/middleware/rate_limit_middleware.dart` — file exists with 3 limiter configs
</verification>

<success_criteria>
- shelf_limiter ^2.0.1 in pubspec.yaml dependencies
- rate_limit_middleware.dart exists with authRateLimiter, mutationRateLimiter, exportRateLimiter
- Auth route wrapped with authRateLimiter (rate limit BEFORE/WITHOUT auth middleware)
- Messages and fines routes wrapped with mutationRateLimiter (after auth middleware)
- Exports route wrapped with exportRateLimiter (after auth middleware)
- Health check NOT rate limited
- All 268 backend tests pass
- `dart analyze` clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-backend-security-input-validation/04-02-SUMMARY.md`
</output>
