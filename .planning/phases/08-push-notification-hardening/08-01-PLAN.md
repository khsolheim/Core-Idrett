---
phase: 08-push-notification-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/pubspec.yaml
  - app/lib/main.dart
  - app/lib/features/notifications/data/notification_local_data_source.dart
  - app/lib/features/notifications/services/foreground_notification_service.dart
  - app/android/app/src/main/AndroidManifest.xml
autonomous: false
user_setup:
  - service: firebase
    why: "FCM push notifications require Firebase project"
    env_vars: []
    dashboard_config:
      - task: "Run 'flutterfire configure' to generate firebase_options.dart and platform config files"
        location: "Terminal — requires Firebase CLI + FlutterFire CLI installed, logged into Firebase"

must_haves:
  truths:
    - "Firebase.initializeApp() runs at app startup without blocking UI"
    - "flutter_local_notifications, retry, and flutter_secure_storage packages installed"
    - "NotificationLocalDataSource can save and read FCM token with timestamp"
    - "ForegroundNotificationService can display local notifications on Android and iOS"
  artifacts:
    - path: "app/lib/features/notifications/data/notification_local_data_source.dart"
      provides: "Secure local FCM token persistence with timestamp"
      contains: "FlutterSecureStorage"
    - path: "app/lib/features/notifications/services/foreground_notification_service.dart"
      provides: "Flutter local notification display for foreground messages"
      contains: "FlutterLocalNotificationsPlugin"
    - path: "app/lib/main.dart"
      provides: "Firebase initialization at startup"
      contains: "Firebase.initializeApp"
  key_links:
    - from: "app/lib/features/notifications/data/notification_local_data_source.dart"
      to: "flutter_secure_storage"
      via: "FlutterSecureStorage instance"
      pattern: "FlutterSecureStorage"
    - from: "app/lib/features/notifications/services/foreground_notification_service.dart"
      to: "flutter_local_notifications"
      via: "FlutterLocalNotificationsPlugin instance"
      pattern: "FlutterLocalNotificationsPlugin"
---

<objective>
Install required packages, initialize Firebase at app startup, and create the two new foundation services: NotificationLocalDataSource (secure token persistence) and ForegroundNotificationService (local notification display).

Purpose: These foundation services are required by Plan 08-02 (token retry/persistence) and Plan 08-03 (foreground display). Without Firebase initialization, no FCM functionality works.

Output: Three new packages installed, Firebase initialized in main.dart, two new service files, Android notification channel configured.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-push-notification-hardening/08-RESEARCH.md
@app/pubspec.yaml
@app/lib/main.dart
@app/lib/features/notifications/providers/notification_provider.dart
@app/lib/features/notifications/data/notification_repository.dart
@app/lib/core/errors/app_exceptions.dart
@app/android/app/src/main/AndroidManifest.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install packages and create foundation services</name>
  <files>
    app/pubspec.yaml
    app/lib/main.dart
    app/lib/features/notifications/data/notification_local_data_source.dart
    app/lib/features/notifications/services/foreground_notification_service.dart
    app/android/app/src/main/AndroidManifest.xml
  </files>
  <action>
    **1. Install packages** in app/pubspec.yaml — add under dependencies:
    ```yaml
    flutter_local_notifications: ^18.0.1
    retry: ^3.1.2
    flutter_secure_storage: ^9.2.2
    ```
    Run `flutter pub get` from `/app`.

    **2. Add Firebase initialization to main.dart:**
    - Add `import 'package:firebase_core/firebase_core.dart';`
    - In the `main()` function, after `WidgetsFlutterBinding.ensureInitialized()` and before the SharedPreferences future, add Firebase initialization inside a try/catch (non-blocking, same pattern as SupabaseService):
    ```dart
    try {
      await Firebase.initializeApp();
    } catch (e) {
      if (kDebugMode) {
        print('Firebase initialization failed: $e');
      }
    }
    ```
    Note: Do NOT import `firebase_options.dart` — the user will run `flutterfire configure` separately to generate it. For now, `Firebase.initializeApp()` without options works when platform config files (google-services.json, GoogleService-Info.plist) exist. Wrap in try/catch so the app doesn't crash if Firebase isn't configured.

    **3. Create `notification_local_data_source.dart`:**
    Path: `app/lib/features/notifications/data/notification_local_data_source.dart`

    This service persists FCM token + last-sync timestamp locally using flutter_secure_storage:

    ```dart
    import 'package:flutter_riverpod/flutter_riverpod.dart';
    import 'package:flutter_secure_storage/flutter_secure_storage.dart';

    final notificationLocalDataSourceProvider = Provider<NotificationLocalDataSource>((ref) {
      return NotificationLocalDataSource();
    });

    class NotificationLocalDataSource {
      final FlutterSecureStorage _storage;

      static const _tokenKey = 'fcm_token';
      static const _timestampKey = 'fcm_token_last_sync';

      NotificationLocalDataSource({FlutterSecureStorage? storage})
          : _storage = storage ?? const FlutterSecureStorage();

      /// Save FCM token and sync timestamp
      Future<void> saveToken(String token, DateTime syncedAt) async {
        await Future.wait([
          _storage.write(key: _tokenKey, value: token),
          _storage.write(key: _timestampKey, value: syncedAt.toIso8601String()),
        ]);
      }

      /// Read stored token and timestamp. Returns (null, null) if not stored.
      Future<(String?, DateTime?)> getToken() async {
        final token = await _storage.read(key: _tokenKey);
        final timestampStr = await _storage.read(key: _timestampKey);
        final timestamp = timestampStr != null ? DateTime.tryParse(timestampStr) : null;
        return (token, timestamp);
      }

      /// Check if stored token needs reregistration (>24 hours since last sync)
      Future<bool> needsReregistration() async {
        final (token, timestamp) = await getToken();
        if (token == null || timestamp == null) return true;
        return DateTime.now().toUtc().difference(timestamp) > const Duration(hours: 24);
      }

      /// Clear stored token (on logout)
      Future<void> clearToken() async {
        await Future.wait([
          _storage.delete(key: _tokenKey),
          _storage.delete(key: _timestampKey),
        ]);
      }
    }
    ```

    **4. Create `foreground_notification_service.dart`:**
    Path: `app/lib/features/notifications/services/foreground_notification_service.dart`

    This service wraps flutter_local_notifications for displaying foreground push notifications:

    ```dart
    import 'package:firebase_messaging/firebase_messaging.dart';
    import 'package:flutter_local_notifications/flutter_local_notifications.dart';
    import 'package:flutter_riverpod/flutter_riverpod.dart';

    final foregroundNotificationServiceProvider = Provider<ForegroundNotificationService>((ref) {
      return ForegroundNotificationService();
    });

    class ForegroundNotificationService {
      final FlutterLocalNotificationsPlugin _plugin;
      bool _initialized = false;

      static const _channelId = 'core_idrett_default';
      static const _channelName = 'Varsler';
      static const _channelDescription = 'Varsler fra Core - Idrett';

      ForegroundNotificationService({FlutterLocalNotificationsPlugin? plugin})
          : _plugin = plugin ?? FlutterLocalNotificationsPlugin();

      /// Initialize the local notifications plugin. Call once.
      Future<void> initialize() async {
        if (_initialized) return;
        _initialized = true;

        const androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');
        const darwinSettings = DarwinInitializationSettings(
          requestAlertPermission: false, // FCM already handles permissions
          requestBadgePermission: false,
          requestSoundPermission: false,
        );

        await _plugin.initialize(
          const InitializationSettings(
            android: androidSettings,
            iOS: darwinSettings,
            macOS: darwinSettings,
          ),
        );

        // Create Android notification channel
        await _plugin
            .resolvePlatformSpecificImplementation<AndroidFlutterLocalNotificationsPlugin>()
            ?.createNotificationChannel(
              const AndroidNotificationChannel(
                _channelId,
                _channelName,
                description: _channelDescription,
                importance: Importance.high,
                playSound: true,
                enableVibration: true,
              ),
            );
      }

      /// Show a local notification from a foreground FCM message
      Future<void> showNotification(RemoteMessage message) async {
        final notification = message.notification;
        if (notification == null) return;

        await _plugin.show(
          notification.hashCode,
          notification.title,
          notification.body,
          const NotificationDetails(
            android: AndroidNotificationDetails(
              _channelId,
              _channelName,
              channelDescription: _channelDescription,
              importance: Importance.high,
              priority: Priority.high,
              icon: '@mipmap/ic_launcher',
            ),
            iOS: DarwinNotificationDetails(
              presentAlert: true,
              presentBadge: true,
              presentSound: true,
            ),
          ),
          payload: message.data['route'],
        );
      }
    }
    ```

    **5. Add notification channel meta-data to AndroidManifest.xml:**
    Inside the `<application>` tag (after the `<activity>` tag), add:
    ```xml
    <!-- FCM default notification channel -->
    <meta-data
        android:name="com.google.firebase.messaging.default_notification_channel_id"
        android:value="core_idrett_default" />
    ```
    This ensures background FCM messages use the same channel as foreground notifications.
  </action>
  <verify>
    Run `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter pub get` — should succeed without errors.
    Run `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter analyze --no-fatal-infos 2>&1 | grep -E "error|warning" | head -20` — no new errors or warnings from our changes (existing pre-known warnings acceptable).
    Verify the two new files exist and compile: `dart analyze app/lib/features/notifications/data/notification_local_data_source.dart app/lib/features/notifications/services/foreground_notification_service.dart`
  </verify>
  <done>
    - flutter_local_notifications, retry, flutter_secure_storage added to pubspec.yaml and resolved
    - Firebase.initializeApp() called in main.dart (wrapped in try/catch)
    - NotificationLocalDataSource created with saveToken/getToken/needsReregistration/clearToken
    - ForegroundNotificationService created with initialize/showNotification
    - AndroidManifest.xml has default notification channel meta-data
    - flutter analyze passes with no new errors
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Firebase for the project</name>
  <action>
    Firebase configuration files are required for FCM to function. Claude cannot create Firebase projects or generate config files.

    The user must:
    1. Install Firebase CLI if not installed: `npm install -g firebase-tools`
    2. Install FlutterFire CLI if not installed: `dart pub global activate flutterfire_cli`
    3. Log in to Firebase: `firebase login`
    4. From the app directory, run: `flutterfire configure`
       - This generates `lib/firebase_options.dart`, `android/app/google-services.json`, and `ios/Runner/GoogleService-Info.plist`
    5. After generation, update `main.dart` to import and use the generated options:
       ```dart
       import 'firebase_options.dart';
       // Change Firebase.initializeApp() to:
       await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
       ```

    Note: If Firebase is already configured for this project elsewhere, the user can copy the existing config files instead.
    If the user wants to skip Firebase setup for now, Plans 08-02 and 08-03 will still work at the code level — FCM calls will simply fail gracefully at runtime until Firebase is configured.
  </action>
  <resume-signal>Type "configured" when Firebase config files exist, or "skip" to proceed without Firebase setup (code will be ready, FCM will fail gracefully at runtime)</resume-signal>
</task>

</tasks>

<verification>
- `flutter pub get` succeeds in app directory
- `flutter analyze --no-fatal-infos` shows no new errors
- `notification_local_data_source.dart` exists with FlutterSecureStorage usage
- `foreground_notification_service.dart` exists with FlutterLocalNotificationsPlugin usage
- `main.dart` contains `Firebase.initializeApp()`
- `AndroidManifest.xml` contains `default_notification_channel_id` meta-data
</verification>

<success_criteria>
Foundation services and packages installed. Firebase initialization added to app startup. NotificationLocalDataSource persists token securely. ForegroundNotificationService can display local notifications. All compile without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/08-push-notification-hardening/08-01-SUMMARY.md`
</output>
