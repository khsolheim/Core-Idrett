---
phase: 08-push-notification-hardening
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app/lib/features/notifications/providers/notification_provider.dart
autonomous: true

must_haves:
  truths:
    - "Foreground push notifications display as local notifications on Android"
    - "Foreground push notifications display as system banners on iOS"
    - "Notification taps are handled (payload accessible for future navigation)"
    - "iOS foreground presentation options configured (alert, badge, sound)"
  artifacts:
    - path: "app/lib/features/notifications/providers/notification_provider.dart"
      provides: "Foreground notification display via ForegroundNotificationService"
      contains: "ForegroundNotificationService"
  key_links:
    - from: "app/lib/features/notifications/providers/notification_provider.dart"
      to: "app/lib/features/notifications/services/foreground_notification_service.dart"
      via: "ref.watch(foregroundNotificationServiceProvider)"
      pattern: "foregroundNotificationServiceProvider"
    - from: "app/lib/features/notifications/providers/notification_provider.dart"
      to: "FirebaseMessaging.onMessage"
      via: "listen callback → _foregroundService.showNotification"
      pattern: "showNotification"
---

<objective>
Wire ForegroundNotificationService into the FcmTokenNotifier so that foreground push notifications actually display to users, and configure iOS foreground presentation options.

Purpose: Currently, foreground messages are received but silently discarded. Users only see notifications when the app is backgrounded. This plan makes notifications visible in all app states.

Output: Updated notification_provider.dart that initializes ForegroundNotificationService and delegates foreground messages to it.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-push-notification-hardening/08-RESEARCH.md
@.planning/phases/08-push-notification-hardening/08-01-SUMMARY.md
@app/lib/features/notifications/providers/notification_provider.dart
@app/lib/features/notifications/services/foreground_notification_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire foreground notification display and iOS presentation options</name>
  <files>app/lib/features/notifications/providers/notification_provider.dart</files>
  <action>
    Update `FcmTokenNotifier` in `notification_provider.dart` to integrate the ForegroundNotificationService created in Plan 08-01.

    **Note:** This plan modifies the same file as Plan 08-02. Since both are wave 2 and depend on 08-01, the executor should apply 08-02 first (it makes larger changes), then 08-03 makes targeted additions on top. If the executor runs 08-03 after 08-02, the file will already have the retry logic — this plan only touches the foreground message handling.

    **1. Add import for ForegroundNotificationService:**
    ```dart
    import '../services/foreground_notification_service.dart';
    ```

    **2. Add dependency in FcmTokenNotifier:**
    ```dart
    late final ForegroundNotificationService _foregroundService;
    ```
    In `build()`, add:
    ```dart
    _foregroundService = ref.watch(foregroundNotificationServiceProvider);
    ```

    **3. Add iOS foreground presentation options in `initialize()`:**
    After the permission check succeeds (inside the `if (settings.authorizationStatus == ...)` block), before getting the token, add:
    ```dart
    // Configure iOS to show notifications when app is in foreground
    if (Platform.isIOS) {
      await messaging.setForegroundNotificationPresentationOptions(
        alert: true,
        badge: true,
        sound: true,
      );
    }

    // Initialize local notifications for foreground display
    await _foregroundService.initialize();
    ```

    **4. Replace the `_handleForegroundMessage` method:**
    Replace the current no-op implementation with:
    ```dart
    void _handleForegroundMessage(RemoteMessage message) {
      // Display foreground notification via flutter_local_notifications
      _foregroundService.showNotification(message);
    }
    ```

    This is a fire-and-forget call — showNotification returns a Future but we don't need to await it in the stream listener. The method signature stays `void` to match the stream listener callback type.

    **Summary of all changes:**
    - 1 new import
    - 1 new field declaration + initialization in build()
    - iOS foreground options + _foregroundService.initialize() added to initialize()
    - _handleForegroundMessage body replaced (1 line → 1 line, but now actually does something)
  </action>
  <verify>
    Run `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter analyze --no-fatal-infos 2>&1 | grep -E "error|warning" | head -20` — no new errors.
    Verify notification_provider.dart contains: foregroundNotificationServiceProvider, setForegroundNotificationPresentationOptions, _foregroundService.showNotification, _foregroundService.initialize().
  </verify>
  <done>
    - ForegroundNotificationService injected via Riverpod provider
    - iOS foreground presentation options set (alert, badge, sound = true)
    - ForegroundNotificationService.initialize() called during FCM setup
    - Foreground messages delegated to _foregroundService.showNotification()
    - Notifications now display in all app states: foreground (local notification), background (system), terminated (system)
    - flutter analyze passes with no new errors
  </done>
</task>

</tasks>

<verification>
- notification_provider.dart imports foreground_notification_service.dart
- _foregroundService field exists and is initialized from provider
- setForegroundNotificationPresentationOptions called with alert/badge/sound=true on iOS
- _foregroundService.initialize() called in initialize()
- _handleForegroundMessage calls _foregroundService.showNotification(message)
- flutter analyze passes
</verification>

<success_criteria>
Foreground push notifications display via local notifications on both Android and iOS. iOS foreground presentation configured. All notification display delegated to ForegroundNotificationService.
</success_criteria>

<output>
After completion, create `.planning/phases/08-push-notification-hardening/08-03-SUMMARY.md`
</output>
