---
phase: 01-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pubspec.yaml
  - backend/lib/models/user.dart
  - backend/lib/models/team.dart
  - backend/lib/models/activity.dart
  - backend/lib/models/message.dart
  - backend/lib/models/fine.dart
  - backend/lib/models/document.dart
  - backend/lib/models/absence.dart
  - backend/lib/models/notification.dart
  - backend/lib/models/export_log.dart
  - backend/lib/models/test.dart
  - backend/lib/models/season.dart
  - backend/lib/models/statistics.dart
  - backend/lib/models/stopwatch.dart
  - backend/lib/models/points_config.dart
  - backend/lib/models/tournament_core.dart
  - backend/lib/models/tournament_round.dart
  - backend/lib/models/tournament_match.dart
  - backend/lib/models/tournament_group.dart
  - backend/lib/models/tournament.dart
  - backend/lib/models/achievement_definition.dart
  - backend/lib/models/achievement_user.dart
  - backend/lib/models/achievement.dart
  - backend/lib/models/mini_activity_core.dart
  - backend/lib/models/mini_activity_team.dart
  - backend/lib/models/mini_activity_adjustment.dart
  - backend/lib/models/mini_activity_statistics.dart
  - backend/lib/models/mini_activity.dart
  - backend/test/helpers/test_data.dart
  - backend/test/helpers/mock_supabase.dart
  - backend/test/helpers/test_helpers.dart
autonomous: true

must_haves:
  truths:
    - "All backend models support structural equality via Equatable (fromJson(toJson(m)) == m)"
    - "Backend test data factories exist for ALL core entities with realistic Norwegian data"
    - "Mock SupabaseClient infrastructure allows service testing without real database"
    - "dart pub get succeeds with all new dependencies"
    - "dart analyze shows zero new errors after Equatable migration"
  artifacts:
    - path: "backend/pubspec.yaml"
      provides: "equatable, mockito, build_runner dependencies"
      contains: "equatable"
    - path: "backend/test/helpers/test_data.dart"
      provides: "Test data factories for all backend models"
      contains: "TestUserFactory"
    - path: "backend/test/helpers/mock_supabase.dart"
      provides: "Mock SupabaseClient for service testing"
      contains: "MockSupabaseClient"
    - path: "backend/test/helpers/test_helpers.dart"
      provides: "Shared test utilities"
      contains: "resetAllTestFactories"
  key_links:
    - from: "backend/lib/models/*.dart"
      to: "package:equatable/equatable.dart"
      via: "extends Equatable"
      pattern: "class .* extends Equatable"
    - from: "backend/test/helpers/test_data.dart"
      to: "backend/lib/models/*.dart"
      via: "import and instantiation"
      pattern: "import.*package:core_idrett_backend/models/"
    - from: "backend/test/helpers/mock_supabase.dart"
      to: "backend/lib/db/supabase_client.dart"
      via: "extends Mock implements SupabaseClient"
      pattern: "MockSupabaseClient"
---

<objective>
Set up backend test infrastructure: add dependencies, migrate all backend models to Equatable for structural equality, create comprehensive test data factories with realistic Norwegian data, and create mock SupabaseClient for service-level testing.

Purpose: Without Equatable on models, roundtrip tests cannot assert equality cleanly. Without factories and mocks, no backend tests can be written. This plan creates the foundation everything else builds on.

Output: Backend models with Equatable, test data factories for all entities, mock database client ready for service tests.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-infrastructure/01-RESEARCH.md
@.planning/phases/01-test-infrastructure/01-CONTEXT.md

# Key source files
@backend/pubspec.yaml
@backend/lib/db/supabase_client.dart
@backend/lib/models/user.dart
@backend/lib/models/team.dart
@backend/lib/models/activity.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dependencies and migrate all backend models to Equatable</name>
  <files>
    backend/pubspec.yaml
    backend/lib/models/user.dart
    backend/lib/models/team.dart
    backend/lib/models/activity.dart
    backend/lib/models/message.dart
    backend/lib/models/fine.dart
    backend/lib/models/document.dart
    backend/lib/models/absence.dart
    backend/lib/models/notification.dart
    backend/lib/models/export_log.dart
    backend/lib/models/test.dart
    backend/lib/models/season.dart
    backend/lib/models/statistics.dart
    backend/lib/models/stopwatch.dart
    backend/lib/models/points_config.dart
    backend/lib/models/tournament_core.dart
    backend/lib/models/tournament_round.dart
    backend/lib/models/tournament_match.dart
    backend/lib/models/tournament_group.dart
    backend/lib/models/achievement_definition.dart
    backend/lib/models/achievement_user.dart
    backend/lib/models/mini_activity_core.dart
    backend/lib/models/mini_activity_team.dart
    backend/lib/models/mini_activity_adjustment.dart
    backend/lib/models/mini_activity_statistics.dart
  </files>
  <action>
    1. Add dependencies to backend/pubspec.yaml:
       - Under `dependencies:` add `equatable: ^2.0.5`
       - Under `dev_dependencies:` add `mockito: ^5.4.4` and `build_runner: ^2.4.0`
       - Run `dart pub get` from backend/

    2. Migrate ALL backend model classes to extend Equatable:
       - Add `import 'package:equatable/equatable.dart';` to each model file
       - Change each class declaration from `class Foo {` to `class Foo extends Equatable {`
       - Add `@override List<Object?> get props => [field1, field2, ...];` including ALL fields (nullable ones too)
       - Add `const` to constructors where possible (Equatable prefers const constructors)
       - Do NOT change any existing fromJson/toJson logic
       - Do NOT modify barrel export files (tournament.dart, mini_activity.dart, achievement.dart)

    3. Backend model files to migrate (24 files with classes):
       - user.dart (1 class: User)
       - team.dart (3 classes: Team, TrainerType, TeamMember)
       - activity.dart (3 classes: Activity, ActivityInstance, ActivityResponse)
       - message.dart (1 class: Message)
       - fine.dart (6 classes: check file for all)
       - document.dart (2 classes: check file)
       - absence.dart (2 classes: check file)
       - notification.dart (2 classes: check file)
       - export_log.dart (3 classes: check file)
       - test.dart (2 classes: check file)
       - season.dart (4 classes: check file)
       - statistics.dart (6 classes: check file)
       - stopwatch.dart (3 classes: check file)
       - points_config.dart (3 classes: check file)
       - tournament_core.dart (1 class: Tournament)
       - tournament_round.dart (1 class: TournamentRound)
       - tournament_match.dart (2 classes: check file)
       - tournament_group.dart (5 classes: check file)
       - achievement_definition.dart (2 classes: check file)
       - achievement_user.dart (2 classes: check file)
       - mini_activity_core.dart (2 classes: check file)
       - mini_activity_team.dart (2 classes: check file)
       - mini_activity_adjustment.dart (2 classes: check file)
       - mini_activity_statistics.dart (5 classes: check file)

    4. For each class, read the file first to identify ALL fields, then add props with every field listed.
       Use `List<Object?>` (with ?) since models have nullable fields.

    5. IMPORTANT: Some backend models accept DateTime directly from Supabase (e.g., `row['created_at'] as DateTime`).
       The Equatable props list should include DateTime fields as-is. Do NOT change fromJson/toJson behavior.

    6. Enums do NOT need Equatable (they already support ==).
  </action>
  <verify>
    Run from backend/:
    - `dart pub get` succeeds
    - `dart analyze` shows zero new errors/warnings (may have pre-existing ones)
    - Verify a few model files have `extends Equatable` and `props` getter
  </verify>
  <done>
    All backend model classes extend Equatable with complete props list. Dependencies installed. dart analyze clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create backend test data factories and mock SupabaseClient</name>
  <files>
    backend/test/helpers/test_data.dart
    backend/test/helpers/mock_supabase.dart
    backend/test/helpers/test_helpers.dart
  </files>
  <action>
    1. Create directory `backend/test/helpers/` if it doesn't exist.

    2. Create `backend/test/helpers/test_data.dart` with factory classes for ALL core backend models.
       Follow the pattern from the frontend test_data.dart but with:
       - Realistic Norwegian names: 'Ola Nordmann', 'Kari Hansen', 'Per Olsen', 'Lise Andersen', 'Erik Johansen', 'Maria Nilsen'
       - Norwegian emails: 'ola.nordmann@example.no'
       - Norwegian team names: 'Rosenborg BK', 'Brann FK', 'Viking FK', 'Molde FK'
       - Norwegian sports: 'Fotball', 'Handball', 'Ishockey'
       - Use UTC DateTime.parse('2024-01-15T10:00:00Z') instead of DateTime.now() for deterministic tests
       - Auto-incrementing counters with reset() methods

       Factories needed (one per model class):
       - TestUserFactory
       - TestTeamFactory
       - TestTrainerTypeFactory
       - TestTeamMemberFactory
       - TestActivityFactory
       - TestActivityInstanceFactory
       - TestActivityResponseFactory
       - TestMessageFactory
       - TestFineFactory (and sub-model factories like TestFineRuleFactory, TestFineAppealFactory, etc.)
       - TestDocumentFactory (and sub-models)
       - TestAbsenceFactory (and sub-models)
       - TestNotificationFactory (and sub-models)
       - TestExportLogFactory (and sub-models)
       - TestTestFactory (physical test model + sub-models)
       - TestSeasonFactory (and sub-models)
       - TestStatisticsFactory (and all 6 sub-classes)
       - TestStopwatchFactory (and sub-models)
       - TestPointsConfigFactory (and sub-models)
       - TestTournamentFactory + TestTournamentRoundFactory + TestTournamentMatchFactory + TestTournamentGroupFactory (and sub-models)
       - TestAchievementDefinitionFactory + TestAchievementUserFactory (and sub-models)
       - TestMiniActivityFactory (core + team + adjustment + statistics sub-models)

       Each factory:
       ```dart
       class TestXxxFactory {
         static int _counter = 0;
         static Xxx create({/* all fields optional with defaults */}) {
           _counter++;
           return Xxx(/* Norwegian defaults */);
         }
         static void reset() => _counter = 0;
       }
       ```

    3. Create `backend/test/helpers/mock_supabase.dart`:
       - This is a custom mock of the backend's own SupabaseClient class (NOT package:supabase)
       - The backend's SupabaseClient (in lib/db/supabase_client.dart) has methods: select(), insert(), insertMany(), update(), delete(), rpc(), and storage methods
       - Use Mockito with @GenerateMocks since this is the backend:
         ```dart
         @GenerateMocks([SupabaseClient])
         import 'mock_supabase.mocks.dart';
         ```
       - Create MockSupabaseHelper class with convenience methods:
         - `stubSelect(table, rows)` - stubs `client.select(table, ...)` to return rows
         - `stubInsert(table, rows)` - stubs `client.insert(table, ...)` to return rows
         - `stubUpdate(table, rows)` - stubs `client.update(table, ...)` to return rows
         - `stubDelete(table)` - stubs `client.delete(table, ...)` to complete
         - `stubRpc(name, result)` - stubs `client.rpc(name, ...)` to return result
       - Run `dart run build_runner build --build-filter="test/**"` from backend/ to generate mocks

    4. Create `backend/test/helpers/test_helpers.dart`:
       - `resetAllTestFactories()` function that resets ALL factory counters
       - Re-export test_data.dart and mock_supabase.dart for convenience
       - Any shared test utilities needed across test files
  </action>
  <verify>
    Run from backend/:
    - `dart run build_runner build --build-filter="test/**"` generates mock_supabase.mocks.dart
    - `dart analyze` shows zero errors in test/ directory
    - Verify test_data.dart imports compile correctly
  </verify>
  <done>
    Test data factories exist for ALL backend model classes with Norwegian test data. MockSupabaseClient generated via Mockito. MockSupabaseHelper provides convenience stubs. resetAllTestFactories() resets all counters.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && dart pub get` succeeds
2. `cd backend && dart analyze` shows zero new errors
3. All 24 model files (non-barrel) contain `extends Equatable` and `props` getter
4. `backend/test/helpers/test_data.dart` exists with factories for all model classes
5. `backend/test/helpers/mock_supabase.dart` exists with MockSupabaseClient
6. `dart run build_runner build --build-filter="test/**"` generates mock file
7. All factory create() methods return valid model instances
</verification>

<success_criteria>
- All backend model classes (~62) extend Equatable with complete props lists
- Backend test data factories cover all core entities with realistic Norwegian data
- MockSupabaseClient generated and MockSupabaseHelper provides convenience stubs
- dart pub get and dart analyze both succeed
- No changes to existing backend behavior (pure additive changes)
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-infrastructure/01-01-SUMMARY.md`
</output>
