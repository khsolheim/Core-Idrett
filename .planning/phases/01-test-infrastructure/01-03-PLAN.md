---
phase: 01-test-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - backend/test/models/user_test.dart
  - backend/test/models/team_test.dart
  - backend/test/models/activity_test.dart
  - backend/test/models/message_test.dart
  - backend/test/models/fine_test.dart
  - backend/test/models/document_test.dart
  - backend/test/models/absence_test.dart
  - backend/test/models/notification_test.dart
  - backend/test/models/export_log_test.dart
  - backend/test/models/test_test.dart
  - backend/test/models/season_test.dart
  - backend/test/models/statistics_test.dart
  - backend/test/models/stopwatch_test.dart
  - backend/test/models/points_config_test.dart
  - backend/test/models/tournament_core_test.dart
  - backend/test/models/tournament_round_test.dart
  - backend/test/models/tournament_match_test.dart
  - backend/test/models/tournament_group_test.dart
  - backend/test/models/achievement_definition_test.dart
  - backend/test/models/achievement_user_test.dart
  - backend/test/models/mini_activity_core_test.dart
  - backend/test/models/mini_activity_team_test.dart
  - backend/test/models/mini_activity_adjustment_test.dart
  - backend/test/models/mini_activity_statistics_test.dart
autonomous: true

must_haves:
  truths:
    - "Every backend model class has a roundtrip test proving fromJson(toJson(m)) == m"
    - "Each model is tested with TWO variants: all optional fields populated, and all optional fields null"
    - "All roundtrip tests pass with dart test"
    - "Test descriptions are in Norwegian"
  artifacts:
    - path: "backend/test/models/user_test.dart"
      provides: "User roundtrip tests"
      contains: "roundtrip"
    - path: "backend/test/models/team_test.dart"
      provides: "Team, TrainerType, TeamMember roundtrip tests"
      contains: "roundtrip"
    - path: "backend/test/models/tournament_core_test.dart"
      provides: "Tournament roundtrip tests"
      contains: "roundtrip"
  key_links:
    - from: "backend/test/models/*_test.dart"
      to: "backend/lib/models/*.dart"
      via: "import and fromJson/toJson calls"
      pattern: "import.*package:core_idrett_backend/models/"
    - from: "backend/test/models/*_test.dart"
      to: "backend/test/helpers/test_data.dart"
      via: "factory usage for test data"
      pattern: "import.*helpers/test_data"
---

<objective>
Write comprehensive roundtrip serialization tests for ALL backend models. Each model class gets two test variants: one with all optional fields populated, and one with all optional fields set to null. Tests verify `fromJson(toJson(model)) == model` using Equatable equality.

Purpose: Roundtrip tests catch serialization bugs (missing fields, wrong keys, type mismatches) that would otherwise surface as runtime errors in production. These tests form the safety net for all subsequent refactoring.

Output: 24 test files covering ~62 model classes with ~124 test cases total.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-infrastructure/01-RESEARCH.md
@.planning/phases/01-test-infrastructure/01-CONTEXT.md

# Must read Plan 01 SUMMARY for Equatable implementation details
@.planning/phases/01-test-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Roundtrip tests for core backend models</name>
  <files>
    backend/test/models/user_test.dart
    backend/test/models/team_test.dart
    backend/test/models/activity_test.dart
    backend/test/models/message_test.dart
    backend/test/models/fine_test.dart
    backend/test/models/document_test.dart
    backend/test/models/absence_test.dart
    backend/test/models/notification_test.dart
    backend/test/models/export_log_test.dart
    backend/test/models/test_test.dart
    backend/test/models/season_test.dart
  </files>
  <action>
    Create backend/test/models/ directory. Write roundtrip tests for these model files:
    user.dart, team.dart, activity.dart, message.dart, fine.dart, document.dart,
    absence.dart, notification.dart, export_log.dart, test.dart, season.dart.

    For EACH class in each model file, write TWO test cases inside a group:

    ```dart
    import 'package:test/test.dart';
    import 'package:core_idrett_backend/models/user.dart';

    void main() {
      group('User', () {
        test('roundtrip med alle felt populert', () {
          final original = User(
            id: 'user-1',
            email: 'ola@example.no',
            name: 'Ola Nordmann',
            avatarUrl: 'https://example.com/avatar.jpg',
            createdAt: DateTime.parse('2024-01-15T10:30:00.000Z'),
          );

          final json = original.toJson();
          final decoded = User.fromJson(json);

          expect(decoded, equals(original));
        });

        test('roundtrip med alle valgfrie felt null', () {
          final original = User(
            id: 'user-2',
            email: 'test@example.no',
            name: 'Test Bruker',
            // avatarUrl is null
            createdAt: DateTime.parse('2024-01-15T10:30:00.000Z'),
          );

          final json = original.toJson();
          final decoded = User.fromJson(json);

          expect(decoded, equals(original));
        });
      });
    }
    ```

    CRITICAL rules:
    1. Read each model file FIRST to identify all fields, their types, and which are optional
    2. Use UTC DateTime.parse() for ALL DateTime values (avoid DST issues)
    3. Use realistic Norwegian data: names, emails, team names, descriptions
    4. Test group and test names MUST be in Norwegian per locked decision
    5. For models with nested sub-models (e.g., Fine has FineAppeal), construct the parent
       with the nested sub-model populated in the "all populated" variant
    6. BACKEND DATETIME ISSUE: Backend models may accept DateTime directly in fromJson
       (e.g., `row['created_at'] as DateTime`), but toJson outputs ISO 8601 strings.
       Roundtrip goes through toJson (DateTime -> String) then fromJson (String -> DateTime).
       Backend fromJson must handle both DateTime and String for roundtrip to work.
       If a model's fromJson does `row['created_at'] as DateTime` (hard cast), the roundtrip
       will fail because toJson outputs a string. In this case:
       - If the model has `createdAt is DateTime ? createdAt : DateTime.parse(...)` pattern, it works
       - If the model has `row['created_at'] as DateTime` (hard cast), note it in the test
         as a known issue for Phase 2 to fix, and use DateTime directly in the test JSON map:
         ```dart
         final json = original.toJson();
         // Fix DateTime string back to DateTime for models that expect DateTime objects
         json['created_at'] = DateTime.parse(json['created_at'] as String);
         final decoded = ModelName.fromJson(json);
         ```
    7. For files with multiple classes, put all groups in one test file
    8. Use `import 'package:test/test.dart';` (not flutter_test - this is backend)
  </action>
  <verify>
    Run from backend/:
    - `dart test test/models/user_test.dart` passes
    - `dart test test/models/team_test.dart` passes
    - `dart test test/models/` runs ALL model tests and they pass
  </verify>
  <done>
    Roundtrip tests exist for all classes in: user, team (3 classes), activity (3 classes),
    message, fine (6 classes), document (2 classes), absence (2 classes), notification (2 classes),
    export_log (3 classes), test (2 classes), season (4 classes). All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Roundtrip tests for complex backend models</name>
  <files>
    backend/test/models/statistics_test.dart
    backend/test/models/stopwatch_test.dart
    backend/test/models/points_config_test.dart
    backend/test/models/tournament_core_test.dart
    backend/test/models/tournament_round_test.dart
    backend/test/models/tournament_match_test.dart
    backend/test/models/tournament_group_test.dart
    backend/test/models/achievement_definition_test.dart
    backend/test/models/achievement_user_test.dart
    backend/test/models/mini_activity_core_test.dart
    backend/test/models/mini_activity_team_test.dart
    backend/test/models/mini_activity_adjustment_test.dart
    backend/test/models/mini_activity_statistics_test.dart
  </files>
  <action>
    Write roundtrip tests for the remaining complex model files:
    statistics.dart (6 classes), stopwatch.dart (3 classes), points_config.dart (3 classes),
    tournament_core.dart, tournament_round.dart, tournament_match.dart (2 classes),
    tournament_group.dart (5 classes), achievement_definition.dart (2 classes),
    achievement_user.dart (2 classes), mini_activity_core.dart (2 classes),
    mini_activity_team.dart (2 classes), mini_activity_adjustment.dart (2 classes),
    mini_activity_statistics.dart (5 classes).

    Follow the same pattern as Task 1:
    1. Read each model file FIRST to understand all fields and types
    2. TWO test cases per class: all populated and all-optional-null
    3. Norwegian test names: `group('KlasseNavn', () { test('roundtrip med alle felt populert', ...) })`
    4. UTC timestamps for all DateTime values
    5. Handle backend DateTime cast issue same as Task 1
    6. For models with enum fields, use valid enum values
    7. For models with List fields, populate with at least 2 items in "all populated" variant
    8. For models with nested objects (e.g., Tournament has TournamentRound list),
       construct nested objects fully in "all populated" variant

    These models are more complex than Task 1 models:
    - statistics.dart has 6 classes with nested statistics data
    - tournament_group.dart has 5 classes with standings, group matches
    - mini_activity_statistics.dart has 5 classes with scoring data
    - points_config.dart has 3 classes with configuration rules

    Take care to read each file completely before writing tests.
  </action>
  <verify>
    Run from backend/:
    - `dart test test/models/statistics_test.dart` passes
    - `dart test test/models/tournament_core_test.dart` passes
    - `dart test test/models/mini_activity_statistics_test.dart` passes
    - `dart test test/models/` runs ALL model tests (both tasks) and they pass
    - Total test count approximately matches 2 * number_of_classes
  </verify>
  <done>
    Roundtrip tests exist for ALL remaining backend model classes: statistics (6), stopwatch (3),
    points_config (3), tournament models (10 classes across 4 files), achievement models (4 classes
    across 2 files), mini_activity models (11 classes across 4 files). All tests pass.
    Combined with Task 1, every backend model class has roundtrip coverage.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && dart test test/models/` runs all roundtrip tests and passes
2. Every model file in backend/lib/models/ has a corresponding test file in backend/test/models/
3. Each model class has exactly 2 test cases (fully populated and all-optional-null)
4. All test group names and test descriptions are in Norwegian
5. Zero test failures
</verification>

<success_criteria>
- All ~62 backend model classes have roundtrip tests (fromJson(toJson(m)) == m)
- Each model tested with two variants: fully populated and optional-fields-null
- All test descriptions in Norwegian
- All tests pass with `dart test test/models/`
- Test files mirror model file names exactly
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-infrastructure/01-03-SUMMARY.md`
</output>
