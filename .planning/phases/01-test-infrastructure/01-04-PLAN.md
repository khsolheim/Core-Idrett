---
phase: 01-test-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - app/test/models/user_test.dart
  - app/test/models/team_test.dart
  - app/test/models/activity_test.dart
  - app/test/models/message_test.dart
  - app/test/models/conversation_test.dart
  - app/test/models/fine_test.dart
  - app/test/models/document_test.dart
  - app/test/models/absence_test.dart
  - app/test/models/notification_test.dart
  - app/test/models/export_log_test.dart
  - app/test/models/stopwatch_test.dart
  - app/test/models/statistics_core_test.dart
  - app/test/models/statistics_player_test.dart
  - app/test/models/points_config_models_test.dart
  - app/test/models/points_config_leaderboard_test.dart
  - app/test/models/tournament_models_test.dart
  - app/test/models/tournament_group_models_test.dart
  - app/test/models/achievement_models_test.dart
  - app/test/models/mini_activity_models_test.dart
  - app/test/models/mini_activity_support_test.dart
  - app/test/models/mini_activity_statistics_core_test.dart
  - app/test/models/mini_activity_statistics_aggregate_test.dart
autonomous: true

must_haves:
  truths:
    - "Every frontend model class has a roundtrip test proving fromJson(toJson(m)) == m"
    - "Each model is tested with TWO variants: all optional fields populated, and all optional fields null"
    - "All roundtrip tests pass with flutter test"
    - "Test descriptions are in Norwegian"
    - "Existing frontend tests still pass alongside new roundtrip tests"
  artifacts:
    - path: "app/test/models/user_test.dart"
      provides: "User roundtrip tests"
      contains: "roundtrip"
    - path: "app/test/models/team_test.dart"
      provides: "Team, TeamMember, TrainerType, TeamSettings roundtrip tests"
      contains: "roundtrip"
    - path: "app/test/models/tournament_models_test.dart"
      provides: "Tournament model roundtrip tests"
      contains: "roundtrip"
  key_links:
    - from: "app/test/models/*_test.dart"
      to: "app/lib/data/models/*.dart"
      via: "import and fromJson/toJson calls"
      pattern: "import.*package:core_idrett/data/models/"
---

<objective>
Write comprehensive roundtrip serialization tests for ALL frontend models. Each model class gets two test variants: one with all optional fields populated, and one with all optional fields set to null. Tests verify `fromJson(toJson(model)) == model` using Equatable equality.

Purpose: Frontend models parse JSON from API responses. Roundtrip tests catch field mapping bugs, type parsing errors, and missing nullable handling that would crash the app at runtime. These tests provide the safety net for frontend refactoring in Phases 5+.

Output: 22 test files covering ~64 model classes with ~128 test cases total.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-infrastructure/01-RESEARCH.md
@.planning/phases/01-test-infrastructure/01-CONTEXT.md

# Must read Plan 02 SUMMARY for Equatable implementation details
@.planning/phases/01-test-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Roundtrip tests for core frontend models</name>
  <files>
    app/test/models/user_test.dart
    app/test/models/team_test.dart
    app/test/models/activity_test.dart
    app/test/models/message_test.dart
    app/test/models/conversation_test.dart
    app/test/models/fine_test.dart
    app/test/models/document_test.dart
    app/test/models/absence_test.dart
    app/test/models/notification_test.dart
    app/test/models/export_log_test.dart
  </files>
  <action>
    Create app/test/models/ directory. Write roundtrip tests for these model files:
    user.dart, team.dart, activity.dart, message.dart, conversation.dart, fine.dart,
    document.dart, absence.dart, notification.dart, export_log.dart.

    For EACH class in each model file, write TWO test cases inside a group:

    ```dart
    import 'package:flutter_test/flutter_test.dart';
    import 'package:core_idrett/data/models/user.dart';

    void main() {
      group('User', () {
        test('roundtrip med alle felt populert', () {
          final original = User(
            id: 'user-1',
            email: 'ola@example.no',
            name: 'Ola Nordmann',
            avatarUrl: 'https://example.com/avatar.jpg',
            birthDate: DateTime.parse('1990-05-15T00:00:00.000Z'),
            createdAt: DateTime.parse('2024-01-15T10:30:00.000Z'),
          );

          final json = original.toJson();
          final decoded = User.fromJson(json);

          expect(decoded, equals(original));
        });

        test('roundtrip med alle valgfrie felt null', () {
          final original = User(
            id: 'user-2',
            email: 'test@example.no',
            name: 'Test Bruker',
            // avatarUrl and birthDate are null
            createdAt: DateTime.parse('2024-01-15T10:30:00.000Z'),
          );

          final json = original.toJson();
          final decoded = User.fromJson(json);

          expect(decoded, equals(original));
        });
      });
    }
    ```

    CRITICAL rules:
    1. Read each model file FIRST to identify all fields, types, and optionality
    2. Use `import 'package:flutter_test/flutter_test.dart';` (this is the frontend)
    3. Use UTC DateTime.parse() for ALL DateTime values
    4. Use realistic Norwegian data: names, emails, team names, descriptions
    5. Test group and test names MUST be in Norwegian per locked decision
    6. FRONTEND DATETIME: Frontend models parse from strings: `DateTime.parse(json['x'] as String)`
       and output strings: `createdAt.toIso8601String()`. Roundtrip should work cleanly
       as long as fromJson expects strings (which frontend models do).
    7. For models with nested sub-models (e.g., Fine has FineAppeal), construct with
       nested sub-model populated in "all populated" variant
    8. For files with multiple classes, put all groups in one test file
    9. For models with enum fields, use valid enum values from the corresponding enum files
    10. For models with List fields, populate with 1-2 items in "all populated" variant
  </action>
  <verify>
    Run from app/:
    - `flutter test test/models/user_test.dart` passes
    - `flutter test test/models/team_test.dart` passes
    - `flutter test test/models/` runs all model roundtrip tests and passes
  </verify>
  <done>
    Roundtrip tests exist for all classes in: user (1), team (4), activity (5),
    message (1), conversation (1), fine (6), document (2), absence (3),
    notification (2), export_log (2). All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Roundtrip tests for complex frontend models</name>
  <files>
    app/test/models/stopwatch_test.dart
    app/test/models/statistics_core_test.dart
    app/test/models/statistics_player_test.dart
    app/test/models/points_config_models_test.dart
    app/test/models/points_config_leaderboard_test.dart
    app/test/models/tournament_models_test.dart
    app/test/models/tournament_group_models_test.dart
    app/test/models/achievement_models_test.dart
    app/test/models/mini_activity_models_test.dart
    app/test/models/mini_activity_support_test.dart
    app/test/models/mini_activity_statistics_core_test.dart
    app/test/models/mini_activity_statistics_aggregate_test.dart
  </files>
  <action>
    Write roundtrip tests for the remaining complex frontend model files:
    stopwatch.dart (3 classes), statistics_core.dart (5 classes),
    statistics_player.dart (6 classes), points_config_models.dart (3 classes),
    points_config_leaderboard.dart (3 classes), tournament_models.dart (4 classes),
    tournament_group_models.dart (5 classes), achievement_models.dart (4 classes),
    mini_activity_models.dart (2 classes), mini_activity_support.dart (6 classes),
    mini_activity_statistics_core.dart (3 classes),
    mini_activity_statistics_aggregate.dart (3 classes).

    Follow the same pattern as Task 1:
    1. Read each model file FIRST to understand all fields, types, optionality
    2. TWO test cases per class: all populated and all-optional-null
    3. Norwegian test names: `group('KlasseNavn', () { test('roundtrip med alle felt populert', ...) })`
    4. UTC timestamps for all DateTime values
    5. For models with enum fields, import enum files and use valid values
    6. For models with List fields, populate with at least 1-2 items
    7. For nested objects, construct fully in "all populated" variant

    These models are more complex:
    - statistics_core.dart + statistics_player.dart have 11 classes total with nested stats
    - tournament_group_models.dart has 5 classes with standings data
    - mini_activity_support.dart has 6 classes with scoring/division data
    - mini_activity_statistics_*.dart have 6 classes with aggregate statistics

    Take care to read each file completely before writing tests.
    Import enum files where needed for enum values used in model constructors.
  </action>
  <verify>
    Run from app/:
    - `flutter test test/models/stopwatch_test.dart` passes
    - `flutter test test/models/tournament_models_test.dart` passes
    - `flutter test test/models/mini_activity_statistics_core_test.dart` passes
    - `flutter test test/models/` runs ALL model roundtrip tests and passes
    - `flutter test` runs ALL tests (existing + new) and passes
  </verify>
  <done>
    Roundtrip tests exist for ALL remaining frontend model classes: stopwatch (3),
    statistics (11 across 2 files), points_config (6 across 2 files),
    tournament (9 across 2 files), achievement (4), mini_activity (11 across 3 files).
    All tests pass. Combined with Task 1, every frontend model class has roundtrip coverage.
  </done>
</task>

</tasks>

<verification>
1. `cd app && flutter test test/models/` runs all roundtrip tests and passes
2. `cd app && flutter test` runs ALL tests (existing widget tests + new model tests) and passes
3. Every model file in app/lib/data/models/ (non-barrel, non-enum) has a corresponding test file
4. Each model class has exactly 2 test cases (fully populated and all-optional-null)
5. All test group names and test descriptions are in Norwegian
6. Zero test failures
</verification>

<success_criteria>
- All ~64 frontend model classes have roundtrip tests (fromJson(toJson(m)) == m)
- Each model tested with two variants: fully populated and optional-fields-null
- All test descriptions in Norwegian
- All tests pass with `flutter test test/models/`
- All existing frontend tests still pass alongside new tests
- Test files mirror model file names exactly
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-infrastructure/01-04-SUMMARY.md`
</output>
