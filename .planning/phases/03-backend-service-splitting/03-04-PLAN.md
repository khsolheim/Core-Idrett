---
phase: 03-backend-service-splitting
plan: 04
type: execute
wave: 1
depends_on: ["03-03"]
files_modified:
  - backend/lib/services/mini_activity_division_service.dart
  - backend/lib/services/mini_activity_division/division_algorithm_service.dart
  - backend/lib/services/mini_activity_division/division_management_service.dart
  - backend/lib/services/points_config_service.dart
  - backend/lib/services/points_config/points_config_crud_service.dart
  - backend/lib/services/points_config/attendance_points_service.dart
  - backend/lib/services/points_config/manual_adjustment_service.dart
  - backend/lib/api/router.dart
  - backend/lib/api/points_config_handler.dart
autonomous: true

must_haves:
  truths:
    - "Mini-activity division service barrel export resolves all 2 sub-service classes"
    - "Points config service barrel export resolves all 3 sub-service classes"
    - "All 8 original services are now split with barrel exports"
    - "All sub-service files are under 400 LOC with focused responsibility"
    - "268 backend tests still pass after all splitting"
  artifacts:
    - path: "backend/lib/services/mini_activity_division_service.dart"
      provides: "Barrel export for division sub-services"
      contains: "export 'mini_activity_division/"
    - path: "backend/lib/services/mini_activity_division/division_algorithm_service.dart"
      provides: "Team division algorithms (random, ranked, age, gmo, cup)"
      contains: "class MiniActivityDivisionAlgorithmService"
    - path: "backend/lib/services/mini_activity_division/division_management_service.dart"
      provides: "Team CRUD, participant management, handicaps"
      contains: "class MiniActivityDivisionManagementService"
    - path: "backend/lib/services/points_config_service.dart"
      provides: "Barrel export for points config sub-services"
      contains: "export 'points_config/"
    - path: "backend/lib/services/points_config/points_config_crud_service.dart"
      provides: "Config CRUD + opt-out + AdjustmentType enum"
      contains: "class PointsConfigCrudService"
    - path: "backend/lib/services/points_config/attendance_points_service.dart"
      provides: "Attendance point operations"
      contains: "class AttendancePointsService"
    - path: "backend/lib/services/points_config/manual_adjustment_service.dart"
      provides: "Manual point adjustments"
      contains: "class ManualAdjustmentService"
  key_links:
    - from: "backend/lib/api/router.dart"
      to: "backend/lib/services/mini_activity_division_service.dart"
      via: "barrel import"
      pattern: "import.*mini_activity_division_service"
    - from: "backend/lib/api/router.dart"
      to: "backend/lib/services/points_config_service.dart"
      via: "barrel import"
      pattern: "import.*points_config_service"
---

<objective>
Split mini_activity_division_service.dart (526 LOC) into 2 focused sub-services and points_config_service.dart (489 LOC) into 3 focused sub-services. Both get barrel exports. Run final verification that ALL 8 services are properly split.

Purpose: Division service mixes complex algorithms with simple CRUD. Points config mixes configuration management, attendance tracking, and manual adjustments. This is the final plan completing Phase 3.
Output: 5 new sub-service files, 2 barrel exports, updated router.dart, final phase verification.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-backend-service-splitting/03-RESEARCH.md
@.planning/phases/03-backend-service-splitting/03-03-SUMMARY.md
@backend/lib/services/mini_activity_division_service.dart
@backend/lib/services/points_config_service.dart
@backend/lib/api/router.dart
@backend/lib/api/points_config_handler.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split mini_activity_division_service.dart and points_config_service.dart into sub-services with barrel exports</name>
  <files>
    backend/lib/services/mini_activity_division_service.dart
    backend/lib/services/mini_activity_division/division_algorithm_service.dart
    backend/lib/services/mini_activity_division/division_management_service.dart
    backend/lib/services/points_config_service.dart
    backend/lib/services/points_config/points_config_crud_service.dart
    backend/lib/services/points_config/attendance_points_service.dart
    backend/lib/services/points_config/manual_adjustment_service.dart
    backend/lib/api/router.dart
    backend/lib/api/points_config_handler.dart
  </files>
  <action>
    **Part A: Split mini_activity_division_service.dart (526 LOC) into 2 files.**

    Create directory `backend/lib/services/mini_activity_division/`.

    1. **division_algorithm_service.dart** (~310 LOC) — `MiniActivityDivisionAlgorithmService`:
       - Constructor: `MiniActivityDivisionAlgorithmService(this._db)`
       - Methods: `divideTeams`, `_addParticipantToTeam`, `_generateTeamNames`
       - Also include private class `_ParticipantData` at the bottom
       - Note: `divideTeams` is the core algorithm (~220 LOC). It creates teams via DB insert and calls `_addParticipantToTeam`. Self-contained.
       - Imports: `dart:math`, `uuid`, `database`, `mini_activity` models, `parsing_helpers`

    2. **division_management_service.dart** (~200 LOC) — `MiniActivityDivisionManagementService`:
       - Constructor: `MiniActivityDivisionManagementService(this._db)`
       - Methods: `resetTeamDivision`, `addLateParticipant`, `updateTeamName`, `moveParticipantToTeam`, `getTeamById`, `getTeamsForMiniActivity`, `removeParticipant`, `deleteTeam`, `createTeam`
       - Plus HANDICAPS methods: `setHandicap`, `getHandicaps`, `removeHandicap`
       - Imports: `uuid`, `database`, `mini_activity` models, `parsing_helpers`

    **Replace mini_activity_division_service.dart with barrel export:**
    ```dart
    // Mini-Activity Division Services - Barrel export
    // Maintains existing import: import '../services/mini_activity_division_service.dart';

    export 'mini_activity_division/division_algorithm_service.dart';
    export 'mini_activity_division/division_management_service.dart';
    ```

    **Update router.dart** — Replace:
    ```dart
    final miniActivityDivisionService = MiniActivityDivisionService(db);
    ```
    With:
    ```dart
    final miniActivityDivisionAlgorithmService = MiniActivityDivisionAlgorithmService(db);
    final miniActivityDivisionManagementService = MiniActivityDivisionManagementService(db);
    ```

    **Check consumers of MiniActivityDivisionService:**
    - `MiniActivitiesHandler` — receives `miniActivityDivisionService` in constructor. Update to receive both sub-services. Read the handler to determine which methods map to which sub-service.

    ---

    **Part B: Split points_config_service.dart (489 LOC) into 3 files.**

    Create directory `backend/lib/services/points_config/`.

    1. **points_config_crud_service.dart** (~230 LOC) — `PointsConfigCrudService`:
       - Constructor: `PointsConfigCrudService(this._db)`
       - Contains the `AdjustmentType` enum at the top of the file (it must be accessible from barrel export)
       - Methods: `getConfig`, `getConfigById`, `getOrCreateConfig`, `createConfig`, `updateConfig`, `deleteConfig`, `setOptOut`, `hasOptedOut`
       - Imports: `uuid`, `database`, `points_config` models, `parsing_helpers`

    2. **attendance_points_service.dart** (~120 LOC) — `AttendancePointsService`:
       - Constructor: `AttendancePointsService(this._db)`
       - Methods: `awardAttendancePoints`, `getUserAttendancePoints`, `getInstanceAttendancePoints`, `hasAttendancePoints`, `getUserAttendanceStats`
       - Imports: `uuid`, `database`, `points_config` models, `parsing_helpers`

    3. **manual_adjustment_service.dart** (~90 LOC) — `ManualAdjustmentService`:
       - Constructor: `ManualAdjustmentService(this._db)`
       - Methods: `createAdjustment`, `getUserAdjustments`, `getTeamAdjustments`, `getUserAdjustmentTotal`
       - Note: `createAdjustment` uses `AdjustmentType` enum — import from sibling file or from barrel. Since barrel re-exports the crud service which defines the enum, importing from the barrel works. But within the sub-directory, import from the crud file directly.
       - Imports: `uuid`, `database`, `points_config` models, `points_config_crud_service` (for AdjustmentType enum), `parsing_helpers`

    **Replace points_config_service.dart with barrel export:**
    ```dart
    // Points Config Services - Barrel export
    // Maintains existing import: import '../services/points_config_service.dart';

    export 'points_config/points_config_crud_service.dart';
    export 'points_config/attendance_points_service.dart';
    export 'points_config/manual_adjustment_service.dart';
    ```

    **Update router.dart** — Replace:
    ```dart
    final pointsConfigService = PointsConfigService(db);
    ```
    With:
    ```dart
    final pointsConfigCrudService = PointsConfigCrudService(db);
    final attendancePointsService = AttendancePointsService(db);
    final manualAdjustmentService = ManualAdjustmentService(db);
    ```

    **Update points_config_handler.dart** — Change constructor from `PointsConfigService` to the 3 sub-services. Read the handler to determine method→sub-service mapping: config CRUD/opt-out → `_crudService`, attendance points → `_attendanceService`, adjustments → `_adjustmentService`.

    **Update MiniActivitiesHandler** if it consumes `miniActivityDivisionService` — update to receive the correct sub-services.
  </action>
  <verify>
    Run `dart analyze` in backend/ — zero new errors.
    Run `dart test` in backend/ — 268 tests pass.
    Verify `wc -l backend/lib/services/mini_activity_division/*.dart` — each 190-310 LOC.
    Verify `wc -l backend/lib/services/points_config/*.dart` — each 80-230 LOC.
  </verify>
  <done>
    MiniActivityDivisionService split into 2 sub-services: Algorithm (~310), Management+Handicaps (~200). PointsConfigService split into 3 sub-services: ConfigCRUD+OptOut (~230), AttendancePoints (~120), ManualAdjustments (~90). Barrel exports at original paths. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Final phase verification — all 8 services split correctly</name>
  <files>
    backend/lib/services/tournament_service.dart
    backend/lib/services/leaderboard_service.dart
    backend/lib/services/fine_service.dart
    backend/lib/services/activity_service.dart
    backend/lib/services/export_service.dart
    backend/lib/services/mini_activity_statistics_service.dart
    backend/lib/services/mini_activity_division_service.dart
    backend/lib/services/points_config_service.dart
  </files>
  <action>
    Run comprehensive verification across all 8 split services:

    1. **Barrel export verification:** For each of the 8 barrel files, verify they contain only `export` directives (no class definitions):
       ```bash
       for f in tournament_service leaderboard_service fine_service activity_service export_service mini_activity_statistics_service mini_activity_division_service points_config_service; do
         echo "=== $f ==="
         cat backend/lib/services/${f}.dart
       done
       ```

    2. **LOC verification:** Count lines in all sub-service files:
       ```bash
       wc -l backend/lib/services/tournament/*.dart
       wc -l backend/lib/services/leaderboard/*.dart
       wc -l backend/lib/services/fine/*.dart
       wc -l backend/lib/services/activity/*.dart
       wc -l backend/lib/services/export/*.dart
       wc -l backend/lib/services/mini_activity_statistics/*.dart
       wc -l backend/lib/services/mini_activity_division/*.dart
       wc -l backend/lib/services/points_config/*.dart
       ```
       Target: all under 400 LOC (ideally under 350).

    3. **No direct sub-service imports from handlers:** Verify handlers only import barrel files:
       ```bash
       grep -r "import.*services/tournament/" backend/lib/api/
       grep -r "import.*services/leaderboard/" backend/lib/api/
       grep -r "import.*services/fine/" backend/lib/api/
       grep -r "import.*services/activity/" backend/lib/api/
       grep -r "import.*services/export/" backend/lib/api/
       grep -r "import.*services/mini_activity_statistics/" backend/lib/api/
       grep -r "import.*services/mini_activity_division/" backend/lib/api/
       grep -r "import.*services/points_config/" backend/lib/api/
       ```
       Should return NO results (handlers should import barrels, not sub-services).

    4. **Static analysis:** `dart analyze` — zero errors, zero warnings related to splitting.

    5. **Test suite:** `dart test` — all 268 tests pass.

    If any issues found, fix them. This is the final cleanup pass for Phase 3.
  </action>
  <verify>
    All 5 verification checks above pass cleanly.
    Total sub-service count: 4 + 3 + 3 + 2 + 2 + 3 + 2 + 3 = 22 sub-service files.
    All barrel exports working.
    268 tests pass.
    dart analyze clean.
  </verify>
  <done>
    Phase 3 complete. All 8 backend services split into 22 focused sub-services with barrel exports. All handlers updated to use sub-services. No import changes needed outside services/ directory. All 268 tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && dart analyze` — zero new errors or warnings
2. `cd backend && dart test` — 268 tests pass
3. All 8 barrel exports contain only `export` directives
4. All 22 sub-service files exist with focused responsibilities
5. No handler imports sub-service paths directly
6. All sub-service files under 400 LOC
</verification>

<success_criteria>
- mini_activity_division_service.dart (526 LOC) → 2 focused sub-services, each under 320 LOC
- points_config_service.dart (489 LOC) → 3 focused sub-services, each under 240 LOC
- ALL 8 original services now split with barrel exports
- ALL 22 sub-service files under 400 LOC
- ALL 268 backend tests pass
- dart analyze clean
- Phase 3 success criteria fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-service-splitting/03-04-SUMMARY.md`
</output>
