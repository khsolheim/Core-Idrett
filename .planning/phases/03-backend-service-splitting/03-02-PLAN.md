---
phase: 03-backend-service-splitting
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/lib/services/fine_service.dart
  - backend/lib/services/fine/fine_rule_service.dart
  - backend/lib/services/fine/fine_crud_service.dart
  - backend/lib/services/fine/fine_summary_service.dart
  - backend/lib/services/activity_service.dart
  - backend/lib/services/activity/activity_crud_service.dart
  - backend/lib/services/activity/activity_query_service.dart
  - backend/lib/api/router.dart
  - backend/lib/api/fines_handler.dart
  - backend/lib/api/activities_handler.dart
autonomous: true

must_haves:
  truths:
    - "Fine service barrel export resolves all 3 sub-service classes"
    - "Activity service barrel export resolves all 2 sub-service classes"
    - "Handlers use sub-service methods identically to before"
    - "268 backend tests still pass after splitting"
  artifacts:
    - path: "backend/lib/services/fine_service.dart"
      provides: "Barrel export for fine sub-services"
      contains: "export 'fine/"
    - path: "backend/lib/services/fine/fine_rule_service.dart"
      provides: "Fine rule CRUD operations"
      contains: "class FineRuleService"
    - path: "backend/lib/services/fine/fine_crud_service.dart"
      provides: "Fine CRUD + appeals + payments"
      contains: "class FineCrudService"
    - path: "backend/lib/services/fine/fine_summary_service.dart"
      provides: "Team and user fine summaries"
      contains: "class FineSummaryService"
    - path: "backend/lib/services/activity_service.dart"
      provides: "Barrel export for activity sub-services"
      contains: "export 'activity/"
    - path: "backend/lib/services/activity/activity_crud_service.dart"
      provides: "Activity CRUD + instance generation"
      contains: "class ActivityCrudService"
    - path: "backend/lib/services/activity/activity_query_service.dart"
      provides: "Activity listing and querying"
      contains: "class ActivityQueryService"
  key_links:
    - from: "backend/lib/api/router.dart"
      to: "backend/lib/services/fine_service.dart"
      via: "barrel import"
      pattern: "import.*fine_service"
    - from: "backend/lib/api/router.dart"
      to: "backend/lib/services/activity_service.dart"
      via: "barrel import"
      pattern: "import.*activity_service"
---

<objective>
Split fine_service.dart (615 LOC) into 3 focused sub-services and activity_service.dart (577 LOC) into 2 focused sub-services. Both get barrel exports maintaining existing import paths.

Purpose: Fine service mixes rule management, fine lifecycle, and summary calculations. Activity service mixes CRUD/generation with complex query logic. Splitting improves single-responsibility adherence.
Output: 5 new sub-service files, 2 barrel exports, updated router.dart and handler constructors.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-backend-service-splitting/03-RESEARCH.md
@.planning/phases/03-backend-service-splitting/03-01-SUMMARY.md
@backend/lib/services/fine_service.dart
@backend/lib/services/activity_service.dart
@backend/lib/api/router.dart
@backend/lib/api/fines_handler.dart
@backend/lib/api/activities_handler.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split fine_service.dart into 3 sub-services with barrel export</name>
  <files>
    backend/lib/services/fine_service.dart
    backend/lib/services/fine/fine_rule_service.dart
    backend/lib/services/fine/fine_crud_service.dart
    backend/lib/services/fine/fine_summary_service.dart
    backend/lib/api/router.dart
    backend/lib/api/fines_handler.dart
  </files>
  <action>
    Create directory `backend/lib/services/fine/`.

    **Split current FineService (615 LOC) into 3 files:**

    1. **fine_rule_service.dart** (~90 LOC) — `FineRuleService`:
       - Constructor: `FineRuleService(this._db)`
       - Methods: `getFineRules`, `createFineRule`, `updateFineRule`, `deleteFineRule`
       - Imports: `uuid`, `database`, `fine` models, `parsing_helpers`

    2. **fine_crud_service.dart** (~320 LOC) — `FineCrudService`:
       - Constructor: `FineCrudService(this._db, this._userService)`
       - Dependencies: `Database`, `UserService`
       - Methods: `getFines`, `getFine`, `createFine`, `approveFine`, `rejectFine`, `createAppeal`, `resolveAppeal`, `getPendingAppeals`, `recordPayment`
       - Note: `getFines` does batch fetching of users, rules, and payments — keep all this logic together
       - Note: `getFine` calls `_userService.getUserMap` — keep this dependency
       - Note: `createFine` calls `getFine` internally — self-referencing, stays in same service
       - Note: `resolveAppeal` updates fine amounts — business logic stays here
       - Imports: `uuid`, `database`, `fine` models, `user_service`, `parsing_helpers`

    3. **fine_summary_service.dart** (~140 LOC) — `FineSummaryService`:
       - Constructor: `FineSummaryService(this._db, this._userService, this._teamService)`
       - Dependencies: `Database`, `UserService`, `TeamService`
       - Methods: `getTeamSummary`, `getUserSummaries`
       - Note: Include `_UserFineData` private helper class at the bottom of this file
       - Imports: `database`, `fine` models, `user_service`, `team_service`, `parsing_helpers`

    **Replace fine_service.dart with barrel export:**
    ```dart
    // Fine Services - Barrel export
    // Maintains existing import: import '../services/fine_service.dart';

    export 'fine/fine_rule_service.dart';
    export 'fine/fine_crud_service.dart';
    export 'fine/fine_summary_service.dart';
    ```

    **Update router.dart** — Replace:
    ```dart
    final fineService = FineService(db, userService, teamService);
    ```
    With:
    ```dart
    final fineRuleService = FineRuleService(db);
    final fineCrudService = FineCrudService(db, userService);
    final fineSummaryService = FineSummaryService(db, userService, teamService);
    ```
    Update FinesHandler instantiation to receive sub-services.

    **Update fines_handler.dart** — Change constructor from `FineService` to individual sub-services. Read the handler to determine which methods map to which sub-service. Rule endpoints → `_ruleService`, fine CRUD/appeal/payment endpoints → `_crudService`, summary endpoints → `_summaryService`.
  </action>
  <verify>
    Run `dart analyze` in backend/ — zero new errors.
    Run `dart test` in backend/ — 268 tests pass.
    Verify `wc -l backend/lib/services/fine/*.dart` — each file 80-320 LOC.
  </verify>
  <done>
    FineService split into 3 sub-services: Rules (~90), CRUD+Appeals+Payments (~320), Summaries (~140). Barrel export at original path. Handler and router.dart updated. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Split activity_service.dart into 2 sub-services with barrel export</name>
  <files>
    backend/lib/services/activity_service.dart
    backend/lib/services/activity/activity_crud_service.dart
    backend/lib/services/activity/activity_query_service.dart
    backend/lib/api/router.dart
    backend/lib/api/activities_handler.dart
  </files>
  <action>
    Create directory `backend/lib/services/activity/`.

    **Split current ActivityService (577 LOC) into 2 files:**

    1. **activity_crud_service.dart** (~220 LOC) — `ActivityCrudService`:
       - Constructor: `ActivityCrudService(this._db)`
       - Methods: `createActivity`, `_generateInstances`, `_createDefaultResponses`, `_calculateDates`, `getTeamIdForActivity`, `deleteActivity`, `updateActivity`, `getTeamMemberIds`
       - Note: `createActivity` calls private `_generateInstances` which calls `_calculateDates` and `_createDefaultResponses` — all stay together
       - Note: These methods don't need `UserService` — `_createDefaultResponses` only queries team_members table
       - Imports: `uuid`, `database`, `activity` models, `parsing_helpers`

    2. **activity_query_service.dart** (~310 LOC) — `ActivityQueryService`:
       - Constructor: `ActivityQueryService(this._db, this._userService)`
       - Dependencies: `Database`, `UserService`
       - Methods: `getActivitiesForTeam`, `getUpcomingInstances`, `getInstanceWithResponses`, `getInstancesByDateRange`
       - Note: `getActivitiesForTeam` uses `groupByCount` from `collection_helpers` — include that import
       - Note: `getInstanceWithResponses` calls `_userService.getUserMap` for response enrichment
       - Imports: `database`, `activity` models, `collection_helpers`, `user_service`, `parsing_helpers`

    **Replace activity_service.dart with barrel export:**
    ```dart
    // Activity Services - Barrel export
    // Maintains existing import: import '../services/activity_service.dart';

    export 'activity/activity_crud_service.dart';
    export 'activity/activity_query_service.dart';
    ```

    **Update router.dart** — Replace:
    ```dart
    final activityService = ActivityService(db, userService);
    ```
    With:
    ```dart
    final activityCrudService = ActivityCrudService(db);
    final activityQueryService = ActivityQueryService(db, userService);
    ```
    Update ActivitiesHandler instantiation to receive sub-services.

    **Update activities_handler.dart** — Change constructor from `ActivityService` to individual sub-services. CRUD/delete/update endpoints → `_crudService`, list/detail/query endpoints → `_queryService`.

    **Check other consumers:** `ActivityInstanceService` in router.dart does NOT depend on `ActivityService` (it depends on its own DB + leaderboard + season). Verify by reading router.dart.
  </action>
  <verify>
    Run `dart analyze` in backend/ — zero new errors.
    Run `dart test` in backend/ — 268 tests pass.
    Verify `wc -l backend/lib/services/activity/*.dart` — each file 200-320 LOC.
  </verify>
  <done>
    ActivityService split into 2 sub-services: CRUD+generation (~220), Query+listing (~310). Barrel export at original path. Handler and router.dart updated. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && dart analyze` — zero new errors or warnings
2. `cd backend && dart test` — 268 tests pass
3. All barrel exports resolve correctly
4. No direct sub-service imports outside services/ directory
5. `wc -l backend/lib/services/fine/*.dart backend/lib/services/activity/*.dart` — all under 350 LOC
</verification>

<success_criteria>
- fine_service.dart (615 LOC) → 3 focused sub-services, each under 320 LOC
- activity_service.dart (577 LOC) → 2 focused sub-services, each under 320 LOC
- Both barrel exports maintain existing import paths
- All 268 backend tests pass unchanged
- dart analyze clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-service-splitting/03-02-SUMMARY.md`
</output>
