---
phase: 03-backend-service-splitting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/lib/services/tournament_service.dart
  - backend/lib/services/tournament/tournament_crud_service.dart
  - backend/lib/services/tournament/tournament_rounds_service.dart
  - backend/lib/services/tournament/tournament_matches_service.dart
  - backend/lib/services/tournament/tournament_bracket_service.dart
  - backend/lib/services/leaderboard_service.dart
  - backend/lib/services/leaderboard/leaderboard_crud_service.dart
  - backend/lib/services/leaderboard/leaderboard_category_service.dart
  - backend/lib/services/leaderboard/leaderboard_ranking_service.dart
  - backend/lib/api/router.dart
  - backend/lib/api/tournaments_handler.dart
autonomous: true

must_haves:
  truths:
    - "Tournament service barrel export resolves all 4 sub-service classes"
    - "Leaderboard service barrel export resolves all 3 sub-service classes"
    - "Handlers use sub-service methods identically to before"
    - "268 backend tests still pass after splitting"
  artifacts:
    - path: "backend/lib/services/tournament_service.dart"
      provides: "Barrel export for tournament sub-services"
      contains: "export 'tournament/"
    - path: "backend/lib/services/tournament/tournament_crud_service.dart"
      provides: "Tournament CRUD operations"
      contains: "class TournamentCrudService"
    - path: "backend/lib/services/tournament/tournament_rounds_service.dart"
      provides: "Tournament round management"
      contains: "class TournamentRoundsService"
    - path: "backend/lib/services/tournament/tournament_matches_service.dart"
      provides: "Tournament match and game operations"
      contains: "class TournamentMatchesService"
    - path: "backend/lib/services/tournament/tournament_bracket_service.dart"
      provides: "Bracket generation and tournament detail"
      contains: "class TournamentBracketService"
    - path: "backend/lib/services/leaderboard_service.dart"
      provides: "Barrel export for leaderboard sub-services"
      contains: "export 'leaderboard/"
    - path: "backend/lib/services/leaderboard/leaderboard_crud_service.dart"
      provides: "Leaderboard CRUD + forwarding methods"
      contains: "class LeaderboardCrudService"
    - path: "backend/lib/services/leaderboard/leaderboard_category_service.dart"
      provides: "Category-based leaderboard management"
      contains: "class LeaderboardCategoryService"
    - path: "backend/lib/services/leaderboard/leaderboard_ranking_service.dart"
      provides: "Ranked views, trends, weighted totals, monthly stats"
      contains: "class LeaderboardRankingService"
  key_links:
    - from: "backend/lib/api/router.dart"
      to: "backend/lib/services/tournament_service.dart"
      via: "barrel import resolves all sub-services"
      pattern: "import.*tournament_service"
    - from: "backend/lib/api/router.dart"
      to: "backend/lib/services/leaderboard_service.dart"
      via: "barrel import resolves all sub-services"
      pattern: "import.*leaderboard_service"
---

<objective>
Split tournament_service.dart (758 LOC) into 4 focused sub-services and leaderboard_service.dart (702 LOC) into 3 focused sub-services. Both get barrel exports maintaining existing import paths.

Purpose: These are the two largest service files. Splitting them improves readability, testability, and makes each concern independently maintainable.
Output: 7 new sub-service files, 2 barrel exports, updated router.dart and tournament handler constructor.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-service-splitting/03-RESEARCH.md
@backend/lib/services/tournament_service.dart
@backend/lib/services/leaderboard_service.dart
@backend/lib/api/router.dart
@backend/lib/api/tournaments_handler.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split tournament_service.dart into 4 sub-services with barrel export</name>
  <files>
    backend/lib/services/tournament_service.dart
    backend/lib/services/tournament/tournament_crud_service.dart
    backend/lib/services/tournament/tournament_rounds_service.dart
    backend/lib/services/tournament/tournament_matches_service.dart
    backend/lib/services/tournament/tournament_bracket_service.dart
    backend/lib/api/router.dart
    backend/lib/api/tournaments_handler.dart
  </files>
  <action>
    Create directory `backend/lib/services/tournament/`.

    **Split current TournamentService (758 LOC) into 4 files:**

    1. **tournament_crud_service.dart** (~130 LOC) — `TournamentCrudService`:
       - Constructor: `TournamentCrudService(this._db)`
       - Methods: `createTournament`, `getTournamentById`, `getTournamentForMiniActivity`, `getTeamIdForTournament`, `getTeamIdForMiniActivity`, `updateTournamentStatus`, `updateTournament`, `deleteTournament`
       - Imports: `uuid`, `database`, `tournament` models, `parsing_helpers`

    2. **tournament_rounds_service.dart** (~80 LOC) — `TournamentRoundsService`:
       - Constructor: `TournamentRoundsService(this._db)`
       - Methods: `createRound`, `getRoundsForTournament`, `updateRoundStatus`, `updateRound`
       - Imports: `uuid`, `database`, `tournament` models

    3. **tournament_matches_service.dart** (~310 LOC) — `TournamentMatchesService`:
       - Constructor: `TournamentMatchesService(this._db)`
       - Methods: `updateMatch`, `startMatch`, `completeMatch`, `declareWalkover`, `createMatch`, `getMatchesForRound`, `getMatchesForTournament`, `getMatchById`, `recordMatchResult`, `setWalkover`, `_advanceTeamToMatch`
       - Also includes all MATCH GAMES (Best-of series) methods: `createGame`, `getGamesForMatch`, `recordGameResult`, `recordGame`, `updateGame`
       - Note: `completeMatch` calls `recordMatchResult` internally which calls `getMatchById` and `_advanceTeamToMatch` — all within same service, so no cross-service dependency needed
       - Imports: `uuid`, `database`, `tournament` models, `parsing_helpers`

    4. **tournament_bracket_service.dart** (~180 LOC) — `TournamentBracketService`:
       - Constructor: `TournamentBracketService(this._db, this._crudService, this._roundsService, this._matchesService, this._groupService)`
       - Dependencies: `TournamentCrudService`, `TournamentRoundsService`, `TournamentMatchesService`, `TournamentGroupService`
       - Methods: `generateSingleEliminationBracket`, `_generateRoundNames`, `getTournamentDetail`
       - Note: `generateSingleEliminationBracket` calls `createRound` (→ _roundsService), `createMatch` (→ _matchesService), `setWalkover` (→ _matchesService), `getMatchesForRound` (→ _matchesService), `updateTournamentStatus` (→ _crudService)
       - Note: `getTournamentDetail` calls `getTournamentById` (→ _crudService), `getRoundsForTournament` (→ _roundsService), `getMatchesForTournament` (→ _matchesService), `groupService.getGroupsForTournament/getGroupStandings/getGroupMatches` (→ _groupService)
       - Imports: `uuid`, `database`, `tournament` models, the 3 sibling services, `tournament_group_service`

    **Replace tournament_service.dart with barrel export:**
    ```dart
    // Tournament Services - Barrel export
    // Maintains existing import: import '../services/tournament_service.dart';

    export 'tournament/tournament_crud_service.dart';
    export 'tournament/tournament_rounds_service.dart';
    export 'tournament/tournament_matches_service.dart';
    export 'tournament/tournament_bracket_service.dart';
    ```

    **Update router.dart** — Replace:
    ```dart
    final tournamentService = TournamentService(db, tournamentGroupService);
    ```
    With:
    ```dart
    final tournamentCrudService = TournamentCrudService(db);
    final tournamentRoundsService = TournamentRoundsService(db);
    final tournamentMatchesService = TournamentMatchesService(db);
    final tournamentBracketService = TournamentBracketService(
      db, tournamentCrudService, tournamentRoundsService, tournamentMatchesService, tournamentGroupService,
    );
    ```
    And update TournamentsHandler instantiation:
    ```dart
    final tournamentsHandler = TournamentsHandler(
      tournamentCrudService, tournamentRoundsService, tournamentMatchesService,
      tournamentBracketService, tournamentGroupService, teamService,
    );
    ```

    **Update tournaments_handler.dart** — Change constructor from `TournamentService` to individual sub-services. Update all method calls from `_tournamentService.xxx()` to the appropriate sub-service (`_crudService.xxx()`, `_roundsService.xxx()`, etc.). Read the handler file carefully to determine which sub-service each call belongs to.

    Each sub-service gets `final _uuid = const Uuid();` only if it uses UUID generation.
    Each sub-service gets `final Database _db;` as its primary dependency.
  </action>
  <verify>
    Run `dart analyze` in backend/ — zero new errors.
    Run `dart test` in backend/ — 268 tests pass.
    Verify `wc -l backend/lib/services/tournament/*.dart` — each file 50-350 LOC.
    Verify `wc -l backend/lib/services/tournament_service.dart` — barrel only, under 10 lines.
  </verify>
  <done>
    TournamentService split into 4 sub-services: CRUD (~130), Rounds (~80), Matches (~310), Bracket (~180). Barrel export at original path. Handler and router.dart updated. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Split leaderboard_service.dart into 3 sub-services with barrel export</name>
  <files>
    backend/lib/services/leaderboard_service.dart
    backend/lib/services/leaderboard/leaderboard_crud_service.dart
    backend/lib/services/leaderboard/leaderboard_category_service.dart
    backend/lib/services/leaderboard/leaderboard_ranking_service.dart
    backend/lib/api/router.dart
  </files>
  <action>
    Create directory `backend/lib/services/leaderboard/`.

    **Split current LeaderboardService (702 LOC) into 3 files:**

    1. **leaderboard_crud_service.dart** (~160 LOC) — `LeaderboardCrudService`:
       - Constructor: `LeaderboardCrudService(this._db, this.entryService)`
       - Dependencies: `Database`, `LeaderboardEntryService`
       - Methods: ALL forwarding methods (lines 19-104: `getLeaderboardEntries`, `getUserEntry`, `upsertEntry`, `addPointsToUsers`, `resetLeaderboard`, `addPointsWithSource`, `hasPointsForSource`, `getPointConfigsForMiniActivity`, `upsertPointConfig`, `deletePointConfig`)
       - Plus CRUD (lines 108-258): `getLeaderboardsForTeam`, `getLeaderboardById`, `getMainLeaderboard`, `createLeaderboard`, `updateLeaderboard`, `deleteLeaderboard`, `getTeamIdForLeaderboard`
       - Imports: `uuid`, `database`, `season` models (for Leaderboard), `mini_activity_statistics` models (for LeaderboardEntry, MiniActivityPointConfig, PointSourceType), `leaderboard_entry_service`, `parsing_helpers`

    2. **leaderboard_category_service.dart** (~90 LOC) — `LeaderboardCategoryService`:
       - Constructor: `LeaderboardCategoryService(this._db, this._crudService)`
       - Dependencies: `Database`, `LeaderboardCrudService`
       - Methods: `getLeaderboardByCategory`, `getOrCreateCategoryLeaderboard`, `getCategoryLeaderboards`
       - Note: `getOrCreateCategoryLeaderboard` creates via `_db.client.insert` directly (not through CrudService.createLeaderboard) — keep this pattern
       - Imports: `uuid`, `database`, `season` models, `parsing_helpers`

    3. **leaderboard_ranking_service.dart** (~250 LOC) — `LeaderboardRankingService`:
       - Constructor: `LeaderboardRankingService(this._db, this._crudService, this._categoryService, this._teamService)`
       - Dependencies: `Database`, `LeaderboardCrudService`, `LeaderboardCategoryService`, `TeamService`
       - Methods: `getRankedEntries`, `getUserRankedPosition`, `getLeaderboardWithTrends`, `calculateWeightedTotal`, `syncTotalLeaderboard`, `getUserMonthlyStats`
       - Note: `getRankedEntries` calls `getLeaderboardByCategory` (→ _categoryService) and `getMainLeaderboard` (→ _crudService)
       - Note: `syncTotalLeaderboard` calls `getOrCreateCategoryLeaderboard` (→ _categoryService), `_teamService.getTeamMemberUserIds`, `getCategoryLeaderboards` (→ _categoryService), `upsertEntry` (→ _crudService.entryService or directly via _crudService forwarding)
       - Note: `calculateWeightedTotal` calls `getCategoryLeaderboards` (→ _categoryService), `getUserEntry` (→ _crudService forwarding)
       - Imports: `database`, `season` models, `mini_activity_statistics` models, `team_service`, `parsing_helpers`

    **Replace leaderboard_service.dart with barrel export:**
    ```dart
    // Leaderboard Services - Barrel export
    // Maintains existing import: import '../services/leaderboard_service.dart';

    export 'leaderboard/leaderboard_crud_service.dart';
    export 'leaderboard/leaderboard_category_service.dart';
    export 'leaderboard/leaderboard_ranking_service.dart';
    ```

    **Update router.dart** — Replace:
    ```dart
    final leaderboardService = LeaderboardService(db, leaderboardEntryService, teamService);
    ```
    With:
    ```dart
    final leaderboardCrudService = LeaderboardCrudService(db, leaderboardEntryService);
    final leaderboardCategoryService = LeaderboardCategoryService(db, leaderboardCrudService);
    final leaderboardRankingService = LeaderboardRankingService(
      db, leaderboardCrudService, leaderboardCategoryService, teamService,
    );
    ```

    **IMPORTANT: LeaderboardService is consumed by multiple services.** Check ALL consumers:
    - `LeaderboardsHandler` — receives `leaderboardService` in constructor. Update to receive sub-services.
    - `ActivityInstanceService` — receives `leaderboardService`. It likely only uses entry operations (forwarding methods). Update to receive `leaderboardCrudService` instead.
    - `MiniActivityResultService` — receives `leaderboardService`. Same analysis — update to the sub-service(s) it actually uses.

    Read each consumer handler/service to determine exactly which sub-services it needs. Update constructors and method calls accordingly. The barrel import path stays the same, but constructors change from `LeaderboardService` to the specific sub-service(s) needed.

    **Update router.dart handler instantiations** to pass correct sub-services to each handler/service that previously received `leaderboardService`.
  </action>
  <verify>
    Run `dart analyze` in backend/ — zero new errors.
    Run `dart test` in backend/ — 268 tests pass.
    Verify `wc -l backend/lib/services/leaderboard/*.dart` — each file 80-260 LOC.
    Verify `wc -l backend/lib/services/leaderboard_service.dart` — barrel only, under 10 lines.
    Verify no handler/service outside services/ imports sub-service paths directly: `grep -r "import.*leaderboard/" backend/lib/api/`
  </verify>
  <done>
    LeaderboardService split into 3 sub-services: CRUD+forwarding (~160), Category (~90), Ranking (~250). Barrel export at original path. All consumers updated. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && dart analyze` — zero new errors or warnings
2. `cd backend && dart test` — 268 tests pass
3. All barrel exports resolve correctly (no "undefined class" errors)
4. No direct sub-service imports outside services/ directory
5. `wc -l backend/lib/services/tournament/*.dart backend/lib/services/leaderboard/*.dart` — all under 350 LOC
</verification>

<success_criteria>
- tournament_service.dart (758 LOC) → 4 focused sub-services, each under 350 LOC
- leaderboard_service.dart (702 LOC) → 3 focused sub-services, each under 260 LOC
- Both barrel exports maintain existing import paths
- All 268 backend tests pass unchanged
- dart analyze clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-service-splitting/03-01-SUMMARY.md`
</output>
