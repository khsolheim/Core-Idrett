---
phase: 03-backend-service-splitting
plan: 03
type: execute
wave: 1
depends_on: ["03-02"]
files_modified:
  - backend/lib/services/export_service.dart
  - backend/lib/services/export/export_data_service.dart
  - backend/lib/services/export/export_utility_service.dart
  - backend/lib/services/mini_activity_statistics_service.dart
  - backend/lib/services/mini_activity_statistics/player_stats_service.dart
  - backend/lib/services/mini_activity_statistics/head_to_head_service.dart
  - backend/lib/services/mini_activity_statistics/stats_aggregation_service.dart
  - backend/lib/api/router.dart
  - backend/lib/api/exports_handler.dart
  - backend/lib/api/mini_activity_statistics_handler.dart
autonomous: true

must_haves:
  truths:
    - "Export service barrel export resolves all 2 sub-service classes"
    - "Mini-activity statistics service barrel export resolves all 3 sub-service classes"
    - "Handlers use sub-service methods identically to before"
    - "268 backend tests still pass after splitting"
  artifacts:
    - path: "backend/lib/services/export_service.dart"
      provides: "Barrel export for export sub-services"
      contains: "export 'export/"
    - path: "backend/lib/services/export/export_data_service.dart"
      provides: "Data export operations (leaderboard, attendance, fines, members, activities)"
      contains: "class ExportDataService"
    - path: "backend/lib/services/export/export_utility_service.dart"
      provides: "CSV generation and export logging"
      contains: "class ExportUtilityService"
    - path: "backend/lib/services/mini_activity_statistics_service.dart"
      provides: "Barrel export for mini-activity statistics sub-services"
      contains: "export 'mini_activity_statistics/"
    - path: "backend/lib/services/mini_activity_statistics/player_stats_service.dart"
      provides: "Player stats CRUD and head-to-head"
      contains: "class MiniActivityPlayerStatsService"
    - path: "backend/lib/services/mini_activity_statistics/head_to_head_service.dart"
      provides: "Head-to-head stats and team history"
      contains: "class MiniActivityHeadToHeadService"
    - path: "backend/lib/services/mini_activity_statistics/stats_aggregation_service.dart"
      provides: "Aggregated stats, leaderboard integration, batch processing"
      contains: "class MiniActivityStatsAggregationService"
  key_links:
    - from: "backend/lib/api/router.dart"
      to: "backend/lib/services/export_service.dart"
      via: "barrel import"
      pattern: "import.*export_service"
    - from: "backend/lib/api/router.dart"
      to: "backend/lib/services/mini_activity_statistics_service.dart"
      via: "barrel import"
      pattern: "import.*mini_activity_statistics_service"
---

<objective>
Split export_service.dart (541 LOC) into 2 focused sub-services and mini_activity_statistics_service.dart (534 LOC) into 3 focused sub-services. Both get barrel exports maintaining existing import paths.

Purpose: Export service mixes data retrieval with utility functions. Mini-activity statistics service mixes player stats, head-to-head, team history, point sources, and aggregation. Splitting groups related operations together.
Output: 5 new sub-service files, 2 barrel exports, updated router.dart and handler constructors.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-backend-service-splitting/03-RESEARCH.md
@.planning/phases/03-backend-service-splitting/03-02-SUMMARY.md
@backend/lib/services/export_service.dart
@backend/lib/services/mini_activity_statistics_service.dart
@backend/lib/api/router.dart
@backend/lib/api/exports_handler.dart
@backend/lib/api/mini_activity_statistics_handler.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split export_service.dart into 2 sub-services with barrel export</name>
  <files>
    backend/lib/services/export_service.dart
    backend/lib/services/export/export_data_service.dart
    backend/lib/services/export/export_utility_service.dart
    backend/lib/api/router.dart
    backend/lib/api/exports_handler.dart
  </files>
  <action>
    Create directory `backend/lib/services/export/`.

    **Split current ExportService (541 LOC) into 2 files:**

    1. **export_data_service.dart** (~460 LOC) — `ExportDataService`:
       - Constructor: `ExportDataService(this._db)`
       - Methods: `exportLeaderboard`, `exportAttendance`, `exportFines`, `exportMembers`, `exportActivities`
       - These are the 5 data export operations. They are large individually but cohesive (same pattern: fetch data, enrich with user info, return structured map). Splitting further would create tiny files.
       - Imports: `database`, `parsing_helpers`

    2. **export_utility_service.dart** (~80 LOC) — `ExportUtilityService`:
       - Constructor: `ExportUtilityService(this._db)`
       - Methods: `generateCsv`, `logExport`, `getExportHistory`
       - Note: `generateCsv` is a pure function on data (no DB needed), but keeping it in a service for consistency
       - Imports: `dart:convert`, `uuid`, `database`, `export_log` model, `parsing_helpers`

    **Replace export_service.dart with barrel export:**
    ```dart
    // Export Services - Barrel export
    // Maintains existing import: import '../services/export_service.dart';

    export 'export/export_data_service.dart';
    export 'export/export_utility_service.dart';
    ```

    **Update router.dart** — Replace:
    ```dart
    final exportService = ExportService(db);
    ```
    With:
    ```dart
    final exportDataService = ExportDataService(db);
    final exportUtilityService = ExportUtilityService(db);
    ```
    Update ExportsHandler instantiation.

    **Update exports_handler.dart** — Change constructor from `ExportService` to `ExportDataService` + `ExportUtilityService`. Data export endpoints → `_dataService`, CSV generation and logging → `_utilityService`.
  </action>
  <verify>
    Run `dart analyze` in backend/ — zero new errors.
    Run `dart test` in backend/ — 268 tests pass.
    Verify `wc -l backend/lib/services/export/*.dart` — each file 70-460 LOC.
    Note: export_data_service.dart will be larger (~460 LOC) because the 5 export methods are cohesive. This is acceptable as splitting them further would create artificial boundaries. The success criteria target is "under 400 LOC" per phase definition, but if the 5 data exports stay slightly over, that's preferable to over-splitting. If any single export method is >100 LOC, consider if it can be extracted, but don't force it.
  </verify>
  <done>
    ExportService split into 2 sub-services: DataExports (~460), Utility/CSV/Logging (~80). Barrel export at original path. Handler and router.dart updated. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Split mini_activity_statistics_service.dart into 3 sub-services with barrel export</name>
  <files>
    backend/lib/services/mini_activity_statistics_service.dart
    backend/lib/services/mini_activity_statistics/player_stats_service.dart
    backend/lib/services/mini_activity_statistics/head_to_head_service.dart
    backend/lib/services/mini_activity_statistics/stats_aggregation_service.dart
    backend/lib/api/router.dart
    backend/lib/api/mini_activity_statistics_handler.dart
  </files>
  <action>
    Create directory `backend/lib/services/mini_activity_statistics/`.

    **Split current MiniActivityStatisticsService (534 LOC) into 3 files:**

    1. **player_stats_service.dart** (~180 LOC) — `MiniActivityPlayerStatsService`:
       - Constructor: `MiniActivityPlayerStatsService(this._db)`
       - Methods: `getPlayerStats`, `getOrCreatePlayerStats`, `getTeamPlayerStats`, `updatePlayerStats`
       - Note: `updatePlayerStats` contains streak calculation logic — keep together
       - Imports: `uuid`, `database`, `mini_activity_statistics` models, `parsing_helpers`

    2. **head_to_head_service.dart** (~140 LOC) — `MiniActivityHeadToHeadService`:
       - Constructor: `MiniActivityHeadToHeadService(this._db)`
       - Methods: `getHeadToHead`, `getOrCreateHeadToHead`, `recordHeadToHeadResult`, `getHeadToHeadForUser`
       - Plus TEAM HISTORY methods: `recordTeamHistory`, `getTeamHistoryForUser`
       - Plus POINT SOURCE methods: `recordPointSource`, `getPointSourcesForUser`, `getPointSourcesForEntry`
       - Imports: `uuid`, `database`, `mini_activity_statistics` models, `parsing_helpers`

    3. **stats_aggregation_service.dart** (~180 LOC) — `MiniActivityStatsAggregationService`:
       - Constructor: `MiniActivityStatsAggregationService(this._db, this._playerStatsService, this._headToHeadService, this._userService)`
       - Dependencies: `Database`, `MiniActivityPlayerStatsService`, `MiniActivityHeadToHeadService`, `UserService`
       - Methods: `getPlayerStatsAggregate`, `getMiniActivityLeaderboard`, `processMiniActivityResults`
       - Note: `getPlayerStatsAggregate` calls `getPlayerStats` (→ _playerStatsService), `getHeadToHeadForUser` (→ _headToHeadService), `getTeamHistoryForUser` (→ _headToHeadService), `getPointSourcesForEntry` (→ _headToHeadService)
       - Note: `processMiniActivityResults` calls `updatePlayerStats` (→ _playerStatsService), `recordTeamHistory` (→ _headToHeadService), `recordHeadToHeadResult` (→ _headToHeadService)
       - Note: `getMiniActivityLeaderboard` calls `getTeamPlayerStats` (→ _playerStatsService), `_userService.getUserMap`
       - Imports: `database`, `mini_activity_statistics` models, `user_service`, `parsing_helpers`

    **Replace mini_activity_statistics_service.dart with barrel export:**
    ```dart
    // Mini-Activity Statistics Services - Barrel export
    // Maintains existing import: import '../services/mini_activity_statistics_service.dart';

    export 'mini_activity_statistics/player_stats_service.dart';
    export 'mini_activity_statistics/head_to_head_service.dart';
    export 'mini_activity_statistics/stats_aggregation_service.dart';
    ```

    **Update router.dart** — Replace:
    ```dart
    final miniActivityStatisticsService = MiniActivityStatisticsService(db, userService);
    ```
    With:
    ```dart
    final miniActivityPlayerStatsService = MiniActivityPlayerStatsService(db);
    final miniActivityHeadToHeadService = MiniActivityHeadToHeadService(db);
    final miniActivityStatsAggregationService = MiniActivityStatsAggregationService(
      db, miniActivityPlayerStatsService, miniActivityHeadToHeadService, userService,
    );
    ```

    **Check all consumers of MiniActivityStatisticsService:**
    - `MiniActivityStatisticsHandler` — update constructor to receive sub-services
    - `MiniActivitiesHandler` — receives `miniActivityStatisticsService` in constructor (line 122 of router.dart). Determine which sub-service(s) it actually needs and update accordingly.

    Update all consumer constructors and method calls.
  </action>
  <verify>
    Run `dart analyze` in backend/ — zero new errors.
    Run `dart test` in backend/ — 268 tests pass.
    Verify `wc -l backend/lib/services/mini_activity_statistics/*.dart` — each file 130-190 LOC.
  </verify>
  <done>
    MiniActivityStatisticsService split into 3 sub-services: PlayerStats (~180), HeadToHead+History+PointSources (~140), Aggregation+Leaderboard+BatchProcessing (~180). Barrel export at original path. All consumers updated. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && dart analyze` — zero new errors or warnings
2. `cd backend && dart test` — 268 tests pass
3. All barrel exports resolve correctly
4. No direct sub-service imports outside services/ directory
5. `wc -l backend/lib/services/export/*.dart backend/lib/services/mini_activity_statistics/*.dart` — reasonable sizes
</verification>

<success_criteria>
- export_service.dart (541 LOC) → 2 focused sub-services
- mini_activity_statistics_service.dart (534 LOC) → 3 focused sub-services, each under 200 LOC
- Both barrel exports maintain existing import paths
- All 268 backend tests pass unchanged
- dart analyze clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-service-splitting/03-03-SUMMARY.md`
</output>
