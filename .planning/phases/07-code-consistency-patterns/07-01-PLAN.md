---
phase: 07-code-consistency-patterns
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/lib/api/statistics_handler.dart
  - backend/lib/api/tournament_groups_handler.dart
  - backend/lib/api/tournament_rounds_handler.dart
  - backend/lib/api/tournaments_handler.dart
  - backend/lib/api/fines_handler.dart
  - backend/lib/api/tournament_matches_handler.dart
autonomous: true

must_haves:
  truths:
    - "All backend handler auth null checks use multi-line if/return format"
    - "All backend error responses use Norwegian messages consistently"
    - "No single-line 'if (userId == null) return resp.unauthorized()' patterns remain"
  artifacts:
    - path: "backend/lib/api/statistics_handler.dart"
      provides: "Multi-line auth pattern"
    - path: "backend/lib/api/tournament_groups_handler.dart"
      provides: "Multi-line auth pattern"
    - path: "backend/lib/api/fines_handler.dart"
      provides: "Multi-line auth pattern"
  key_links:
    - from: "backend/lib/api/*_handler.dart"
      to: "backend/lib/api/helpers/auth_helpers.dart"
      via: "getUserId, requireTeamMember, isAdmin"
      pattern: "if \\(userId == null\\) \\{"
---

<objective>
Standardize backend handler auth patterns and Norwegian error messages across all 32 handlers.

Purpose: Eliminate formatting inconsistency (single-line vs multi-line auth returns) and ensure all error messages are in Norwegian, fulfilling CONS-01 and CONS-02.

Output: All 32 backend handlers follow identical multi-line auth pattern with consistent Norwegian error messages.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-code-consistency-patterns/07-RESEARCH.md
@backend/lib/api/helpers/auth_helpers.dart
@backend/lib/api/helpers/response_helpers.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Standardize auth return formatting to multi-line in 6 handlers</name>
  <files>
    backend/lib/api/statistics_handler.dart
    backend/lib/api/tournament_groups_handler.dart
    backend/lib/api/tournament_rounds_handler.dart
    backend/lib/api/tournaments_handler.dart
    backend/lib/api/fines_handler.dart
    backend/lib/api/tournament_matches_handler.dart
  </files>
  <action>
These 6 handlers use single-line auth return format (`if (userId == null) return resp.unauthorized();`). Convert ALL occurrences to the standard multi-line format:

```dart
// FROM (single-line):
if (userId == null) return resp.unauthorized();

// TO (multi-line):
if (userId == null) {
  return resp.unauthorized();
}
```

Similarly for requireTeamMember checks:
```dart
// FROM:
if (team == null) return resp.forbidden('...');

// TO:
if (team == null) {
  return resp.forbidden('...');
}
```

And isAdmin/role checks:
```dart
// FROM:
if (!isAdmin(team)) return resp.forbidden('...');

// TO:
if (!isAdmin(team)) {
  return resp.forbidden('...');
}
```

Occurrence counts by file:
- statistics_handler.dart: 3 single-line returns
- tournament_groups_handler.dart: 14 single-line returns
- tournament_rounds_handler.dart: 3 single-line returns
- tournaments_handler.dart: 6 single-line returns
- fines_handler.dart: 15 single-line returns
- tournament_matches_handler.dart: 9 single-line returns

Total: ~50 single-line returns to convert. DO NOT change any logic, only formatting.
  </action>
  <verify>
Run: `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze`
Then verify no single-line auth returns remain: `grep -rn "if (userId == null) return" backend/lib/api/` should return 0 results.
Also: `grep -rn "if (team == null) return" backend/lib/api/` should return 0 results.
Also: `grep -rn "if (!isAdmin" backend/lib/api/ | grep "return"` should only show multi-line patterns.
  </verify>
  <done>All 50 single-line auth return patterns converted to multi-line. Zero single-line auth returns remain across all 32 handlers. `dart analyze` passes.</done>
</task>

<task type="auto">
  <name>Task 2: Audit and standardize Norwegian error messages across all handlers</name>
  <files>
    backend/lib/api/statistics_handler.dart
    backend/lib/api/tournament_groups_handler.dart
    backend/lib/api/tournament_rounds_handler.dart
    backend/lib/api/tournaments_handler.dart
    backend/lib/api/fines_handler.dart
    backend/lib/api/tournament_matches_handler.dart
  </files>
  <action>
Audit all 6 handlers (same files from Task 1, since other 26 handlers already use multi-line and were standardized in prior phases) for:

1. **English error messages** -- Replace with Norwegian equivalents:
   - "Not found" -> "Ikke funnet"
   - "Forbidden" / "Access denied" -> "Ingen tilgang"
   - "Invalid input" / "Bad request" -> "Ugyldig forespørsel"
   - "Server error" / "Internal error" -> "En feil oppstod"
   - "Not a member" -> "Ingen tilgang til dette laget"
   - "Admin only" -> "Kun administratorer kan utføre denne handlingen"

2. **resp.forbidden() without message** -- Add Norwegian message:
   - `resp.forbidden()` -> `resp.forbidden('Ingen tilgang til dette laget')`

3. **resp.serverError() with `$e`** -- Remove exception details (should have been caught in Phase 14, but verify):
   - `resp.serverError('Error: $e')` -> `resp.serverError('En feil oppstod')`

4. **Standardize common error messages** to use these exact strings:
   - Unauthorized: (no message, default is fine)
   - Not team member: `'Ingen tilgang til dette laget'`
   - Not admin: `'Kun administratorer kan utføre denne handlingen'`
   - Not coach or admin: `'Kun trenere eller administratorer kan utføre denne handlingen'`
   - Not fine boss: `'Kun bøtesjef eller admin kan utføre denne handlingen'`
   - Not found (generic): `'Ressursen ble ikke funnet'`
   - Bad request (missing field): `'Påkrevd felt mangler'`
   - Server error (generic): `'En feil oppstod'`
   - Server error (fetch): `'Kunne ikke hente data'`
   - Server error (save): `'Kunne ikke lagre endringer'`
   - Server error (delete): `'Kunne ikke slette'`

Also grep ALL 32 handler files for any remaining English error messages or `$e` in serverError calls. Fix any found.
  </action>
  <verify>
Run: `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze`
Verify no English error strings: `grep -rn "resp\.\(forbidden\|badRequest\|notFound\|serverError\)" backend/lib/api/ | grep -i "not found\|forbidden\|access denied\|invalid\|error:"` should return 0 results.
Verify no `$e` in error responses: `grep -rn 'serverError.*\$e' backend/lib/api/` should return 0 results.
Run: `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test` to verify no behavioral changes.
  </verify>
  <done>All handler error messages use consistent Norwegian text. Zero English error messages remain. Zero `$e` in serverError calls. All backend tests pass.</done>
</task>

</tasks>

<verification>
1. `dart analyze` in backend/ passes with zero errors
2. `dart test` in backend/ passes (no behavioral changes)
3. `grep -rn "if (userId == null) return" backend/lib/api/` returns zero results
4. `grep -rn "if (team == null) return resp\." backend/lib/api/` returns zero results
5. All error messages in Norwegian
</verification>

<success_criteria>
- All 32 backend handlers use multi-line if/return for auth checks
- All error messages are Norwegian
- No `$e` in any serverError call
- Backend analyze and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-code-consistency-patterns/07-01-SUMMARY.md`
</output>
