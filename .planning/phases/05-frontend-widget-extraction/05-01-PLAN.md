---
phase: 05-frontend-widget-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/lib/features/chat/presentation/widgets/message_widgets.dart
  - app/lib/features/chat/presentation/widgets/message_bubble.dart
  - app/lib/features/chat/presentation/widgets/message_input_widgets.dart
  - app/lib/features/chat/presentation/widgets/new_conversation_sheet.dart
  - app/lib/features/chat/presentation/widgets/message_helpers.dart
  - app/lib/features/chat/presentation/widgets/widgets.dart
  - app/lib/features/tests/presentation/test_detail_screen.dart
  - app/lib/features/tests/presentation/widgets/test_ranking_tab.dart
  - app/lib/features/tests/presentation/widgets/test_results_tab.dart
  - app/lib/features/tests/presentation/widgets/record_result_sheet.dart
  - app/lib/features/tests/presentation/widgets/widgets.dart
autonomous: true

must_haves:
  truths:
    - "message_widgets.dart is under 350 LOC after extraction"
    - "test_detail_screen.dart is under 350 LOC after extraction"
    - "All chat functionality works identically (send, reply, edit, delete messages)"
    - "All test detail functionality works identically (ranking, results, record)"
    - "flutter analyze shows no new errors"
  artifacts:
    - path: "app/lib/features/chat/presentation/widgets/message_bubble.dart"
      provides: "MessageBubble widget with reply/edit/delete long-press options"
    - path: "app/lib/features/chat/presentation/widgets/message_input_widgets.dart"
      provides: "ReplyEditIndicator and MessageInputBar widgets"
    - path: "app/lib/features/chat/presentation/widgets/new_conversation_sheet.dart"
      provides: "NewConversationSheet ConsumerWidget"
    - path: "app/lib/features/chat/presentation/widgets/message_helpers.dart"
      provides: "isSameDay utility, showDeleteMessageDialog, DateDivider widget"
    - path: "app/lib/features/tests/presentation/widgets/test_ranking_tab.dart"
      provides: "_RankingTab extracted as public TestRankingTab"
    - path: "app/lib/features/tests/presentation/widgets/test_results_tab.dart"
      provides: "_ResultsTab extracted as public TestResultsTab"
    - path: "app/lib/features/tests/presentation/widgets/record_result_sheet.dart"
      provides: "RecordResultSheet (was _RecordResultSheet, now public)"
  key_links:
    - from: "app/lib/features/chat/presentation/widgets/chat_panel.dart"
      to: "message_widgets.dart or barrel"
      via: "import"
      pattern: "import.*message_widgets|import.*widgets.dart"
    - from: "app/lib/features/chat/presentation/widgets/conversation_list_panel.dart"
      to: "message_widgets.dart or barrel"
      via: "import"
      pattern: "import.*message_widgets|import.*widgets.dart"
    - from: "app/lib/core/router.dart"
      to: "test_detail_screen.dart"
      via: "import"
      pattern: "import.*test_detail_screen"
---

<objective>
Split message_widgets.dart (482 LOC) and test_detail_screen.dart (476 LOC) into focused widget files under 350 LOC each.

Purpose: Reduce file size for maintainability and enable Flutter rebuild optimization through widget composition. These two files are in independent features (chat, tests) with no shared files.
Output: 7 new widget files, 2 updated barrel exports, 2 reduced source files.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-frontend-widget-extraction/05-RESEARCH.md
@app/lib/features/chat/presentation/widgets/message_widgets.dart
@app/lib/features/chat/presentation/widgets/widgets.dart
@app/lib/features/chat/presentation/widgets/chat_panel.dart
@app/lib/features/chat/presentation/widgets/conversation_list_panel.dart
@app/lib/features/tests/presentation/test_detail_screen.dart
@app/lib/core/router.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split message_widgets.dart into 4 focused files</name>
  <files>
    app/lib/features/chat/presentation/widgets/message_bubble.dart
    app/lib/features/chat/presentation/widgets/message_input_widgets.dart
    app/lib/features/chat/presentation/widgets/new_conversation_sheet.dart
    app/lib/features/chat/presentation/widgets/message_helpers.dart
    app/lib/features/chat/presentation/widgets/message_widgets.dart
    app/lib/features/chat/presentation/widgets/widgets.dart
  </files>
  <action>
    Split message_widgets.dart (482 LOC, 5 widgets + 2 utility functions) into 4 files:

    1. **message_bubble.dart** (~170 LOC): Extract the `MessageBubble` class (lines 91-262) including its `_showMessageOptions` method. Needs imports: flutter/material, intl, message model.

    2. **message_input_widgets.dart** (~110 LOC): Extract `ReplyEditIndicator` (lines 264-313) and `MessageInputBar` (lines 316-373). These are both message input area widgets. Needs imports: flutter/material, message model.

    3. **new_conversation_sheet.dart** (~110 LOC): Extract `NewConversationSheet` (lines 376-482). This is a ConsumerWidget needing: flutter/material, flutter_riverpod, cached_network_image, conversation model, auth_provider, team_provider, unified_chat_provider, async_value_extensions.

    4. **message_helpers.dart** (~90 LOC): Extract `isSameDay` function (lines 13-15), `showDeleteMessageDialog` function (lines 20-42), and `DateDivider` widget (lines 45-88). Needs imports: flutter/material, intl.

    After extraction, **message_widgets.dart becomes a barrel file** re-exporting all 4 new files:
    ```dart
    export 'message_bubble.dart';
    export 'message_helpers.dart';
    export 'message_input_widgets.dart';
    export 'new_conversation_sheet.dart';
    ```

    This preserves existing imports in chat_panel.dart and conversation_list_panel.dart which import message_widgets.dart directly (not via barrel). The barrel widgets.dart already exports message_widgets.dart, so the chain works.

    All extracted widgets keep their exact class names, constructor signatures, and public APIs. Use const constructors where already present. Each file gets only the imports it actually needs.
  </action>
  <verify>
    Run: `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter analyze lib/features/chat/`
    Expected: No new errors or warnings.
    Run: `wc -l lib/features/chat/presentation/widgets/message_bubble.dart lib/features/chat/presentation/widgets/message_input_widgets.dart lib/features/chat/presentation/widgets/new_conversation_sheet.dart lib/features/chat/presentation/widgets/message_helpers.dart`
    Expected: Each file under 350 LOC.
  </verify>
  <done>message_widgets.dart converted to barrel file. 4 focused widget files created, each under 350 LOC. flutter analyze shows no new errors. Existing imports via message_widgets.dart and widgets.dart barrel continue working.</done>
</task>

<task type="auto">
  <name>Task 2: Split test_detail_screen.dart into screen + 3 widget files</name>
  <files>
    app/lib/features/tests/presentation/test_detail_screen.dart
    app/lib/features/tests/presentation/widgets/test_ranking_tab.dart
    app/lib/features/tests/presentation/widgets/test_results_tab.dart
    app/lib/features/tests/presentation/widgets/record_result_sheet.dart
    app/lib/features/tests/presentation/widgets/widgets.dart
  </files>
  <action>
    Split test_detail_screen.dart (476 LOC, 1 screen + 3 private widgets) into 4 files:

    First, create the `app/lib/features/tests/presentation/widgets/` directory (it does not exist yet).

    1. **test_ranking_tab.dart** (~110 LOC): Extract `_RankingTab` (lines 125-233) as public `TestRankingTab`. Make class public by removing underscore. Keep `_getRankColor`, `_getRankBadgeColor`, `_formatValue` as private methods within the class. Needs imports: flutter/material, statistics model (for TestTemplate).

    2. **test_results_tab.dart** (~115 LOC): Extract `_ResultsTab` (lines 235-348) as public `TestResultsTab`. Make class public. Keep `_formatValue`, `_confirmDelete` as private methods. Needs imports: flutter/material, intl, statistics model (for TestResult, TestTemplate).

    3. **record_result_sheet.dart** (~130 LOC): Extract `_RecordResultSheet` + `_RecordResultSheetState` (lines 350-476) as public `RecordResultSheet`. Make both classes public. Needs imports: flutter/material, flutter_riverpod, async_value_extensions, statistics model (TestTemplate), team_provider.

    4. **test_detail_screen.dart** (~125 LOC): Remains with `TestDetailScreen` + `_TestDetailScreenState` (lines 1-123). Update to import the 3 extracted widgets. Update references from `_RankingTab` to `TestRankingTab`, `_ResultsTab` to `TestResultsTab`, `_RecordResultSheet` to `RecordResultSheet`.

    Create **widgets/widgets.dart** barrel file:
    ```dart
    export 'record_result_sheet.dart';
    export 'test_ranking_tab.dart';
    export 'test_results_tab.dart';
    ```

    Update test_detail_screen.dart imports to use `import 'widgets/widgets.dart';`
  </action>
  <verify>
    Run: `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter analyze lib/features/tests/`
    Expected: No new errors or warnings.
    Run: `wc -l lib/features/tests/presentation/test_detail_screen.dart lib/features/tests/presentation/widgets/test_ranking_tab.dart lib/features/tests/presentation/widgets/test_results_tab.dart lib/features/tests/presentation/widgets/record_result_sheet.dart`
    Expected: Each file under 350 LOC. test_detail_screen.dart reduced from 476 to ~125.
  </verify>
  <done>test_detail_screen.dart reduced to ~125 LOC. 3 new widget files created in new widgets/ directory with barrel export. All private widgets made public with updated references. flutter analyze shows no new errors.</done>
</task>

</tasks>

<verification>
1. `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter analyze lib/features/chat/ lib/features/tests/` -- zero new errors
2. All original widget files (message_widgets.dart, test_detail_screen.dart) under 350 LOC or converted to barrel
3. No files in the split exceed 350 LOC
4. Existing imports from chat_panel.dart, conversation_list_panel.dart, router.dart still resolve
</verification>

<success_criteria>
- message_widgets.dart converted to barrel re-exporting 4 new files
- test_detail_screen.dart reduced from 476 to ~125 LOC
- 7 new widget files created, all under 350 LOC
- flutter analyze passes with no new errors on chat and tests features
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-widget-extraction/05-01-SUMMARY.md`
</output>
