---
phase: 11-ci-pipeline-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/backend.yml
  - backend/pubspec.yaml
autonomous: true

must_haves:
  truths:
    - "A PR touching backend/ triggers dart analyze + dart test automatically"
    - "Pre-existing info-level warnings do not block CI"
    - "Backend test coverage is generated in LCOV format for Codecov"
  artifacts:
    - path: ".github/workflows/backend.yml"
      provides: "Backend CI workflow with analyze, test, and coverage"
      contains: "dart analyze"
    - path: "backend/pubspec.yaml"
      provides: "coverage dev dependency for LCOV generation"
      contains: "coverage:"
  key_links:
    - from: ".github/workflows/backend.yml"
      to: "backend/**"
      via: "paths trigger filter"
      pattern: "paths:.*backend/"
    - from: ".github/workflows/backend.yml"
      to: "coverage/lcov.info"
      via: "format_coverage conversion step"
      pattern: "format_coverage"
---

<objective>
Create the GitHub Actions CI workflow for the Dart backend that runs static analysis and tests with coverage on every PR.

Purpose: Automate backend quality checks (CI-01) and generate coverage data (COV-01) so backend regressions are caught before merge.
Output: `.github/workflows/backend.yml` ready to trigger on PRs touching `backend/**`.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-ci-pipeline-coverage/11-CONTEXT.md
@.planning/phases/11-ci-pipeline-coverage/11-RESEARCH.md
@backend/pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add coverage dev dependency to backend</name>
  <files>backend/pubspec.yaml</files>
  <action>
Add `coverage: ^1.11.0` to `dev_dependencies` in `backend/pubspec.yaml`. This package provides the `format_coverage` tool needed to convert Dart's JSON coverage output to LCOV format that Codecov can consume.

Run `dart pub get` from the backend directory to verify the dependency resolves.

Do NOT add any other dependencies. Do NOT modify any existing dependencies.
  </action>
  <verify>Run `cd backend && dart pub get` — exits 0 with no errors. Run `dart pub deps | grep coverage` to confirm the package is installed.</verify>
  <done>backend/pubspec.yaml has `coverage` in dev_dependencies and `dart pub get` succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Create backend CI workflow</name>
  <files>.github/workflows/backend.yml</files>
  <action>
Create `.github/workflows/backend.yml` with the following structure:

**Workflow name:** `Backend CI`

**Triggers:**
- `push` to `main` branch, paths: `backend/**`, `.github/workflows/backend.yml`
- `pull_request` to `main` branch, paths: `backend/**`, `.github/workflows/backend.yml`

**Job: `test`** on `ubuntu-latest`

**Steps:**
1. `actions/checkout@v4`
2. `dart-lang/setup-dart@v1` with `sdk: 'stable'` (has automatic pub caching built in)
3. **Install dependencies:** `dart pub get` with `working-directory: ./backend`
4. **Analyze code:** `dart analyze --no-fatal-warnings` with `working-directory: ./backend`
   - Use `--no-fatal-warnings` per user decision to allow the 5 known info-level deprecation warnings
   - Do NOT use `--fatal-infos` or `--fatal-warnings`
5. **Run tests with coverage:** `dart test --coverage=coverage` with `working-directory: ./backend`
6. **Convert coverage to LCOV:** Run `dart run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on=lib/` with `working-directory: ./backend`
   - This converts Dart's JSON coverage output to LCOV format
   - `--report-on=lib/` limits coverage to source code (excludes test files)
7. **Upload coverage to Codecov:** `codecov/codecov-action@v5` with:
   - `files: ./backend/coverage/lcov.info`
   - `flags: backend`
   - `fail_ci_if_error: false` (do not block CI if Codecov is down — coverage is informational)
   - `token: ${{ secrets.CODECOV_TOKEN }}` (works for public repos too, future-proofs against visibility changes)

Important implementation details:
- Do NOT use `actions/cache` — `setup-dart@v1` has built-in pub caching
- Do NOT use `continue-on-error` on analyze or test steps — those must fail the workflow
- The `fail_ci_if_error: false` on Codecov upload is intentional — Codecov downtime should not block PRs
  </action>
  <verify>Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/backend.yml'))"` from repo root. Verify the file contains all required steps: checkout, setup-dart, pub get, analyze, test, format_coverage, codecov upload.</verify>
  <done>`.github/workflows/backend.yml` exists with valid YAML, triggers on backend/** changes for push/PR to main, runs analyze with --no-fatal-warnings, runs tests with coverage, converts to LCOV, and uploads to Codecov.</done>
</task>

</tasks>

<verification>
- `backend/pubspec.yaml` includes `coverage` in dev_dependencies
- `.github/workflows/backend.yml` is valid YAML
- Workflow triggers only on `backend/**` and `.github/workflows/backend.yml` path changes
- Workflow uses `--no-fatal-warnings` for analyze (not `--fatal-warnings`)
- Coverage conversion step uses `format_coverage` with `--report-on=lib/`
- Codecov upload has `fail_ci_if_error: false`
</verification>

<success_criteria>
Backend CI workflow file exists and is syntactically valid. The workflow will run analyze + test + coverage on PRs touching backend code, with pre-existing warnings allowed through.
</success_criteria>

<output>
After completion, create `.planning/phases/11-ci-pipeline-coverage/11-01-SUMMARY.md`
</output>
