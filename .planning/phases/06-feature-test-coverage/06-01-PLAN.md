---
phase: 06-feature-test-coverage
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/test/services/export_service_test.dart
  - backend/test/services/statistics_service_test.dart
autonomous: true

must_haves:
  truths:
    - "ExportDataService tests cover all 5 export types (leaderboard, attendance, fines, activities, members)"
    - "ExportDataService tests validate output structure (type, columns, data fields)"
    - "ExportDataService tests handle empty data edge cases (no entries, no members, no activities)"
    - "ExportUtilityService tests cover CSV generation with delimiter escaping and boolean formatting"
    - "StatisticsService tests cover getLeaderboard with zero members, multiple members, sorting by points+rating"
    - "StatisticsService tests cover getTeamAttendance with zero activities, date range filtering, percentage calculation"
    - "StatisticsService tests cover getPlayerStatistics with no membership, no activities, normal flow"
    - "Statistics tests verify zero-division prevention (0 activities returns 0.0 percentage, not NaN)"
  artifacts:
    - path: "backend/test/services/export_service_test.dart"
      provides: "Export service unit tests"
      min_lines: 200
    - path: "backend/test/services/statistics_service_test.dart"
      provides: "Statistics service unit tests"
      min_lines: 200
  key_links:
    - from: "backend/test/services/export_service_test.dart"
      to: "backend/lib/services/export/export_data_service.dart"
      via: "mocktail mock of Database + SupabaseClient"
      pattern: "MockDatabase|MockSupabaseClient"
    - from: "backend/test/services/statistics_service_test.dart"
      to: "backend/lib/services/statistics_service.dart"
      via: "mocktail mocks of Database, UserService, TeamService, PlayerRatingService"
      pattern: "MockDatabase|MockUserService|MockTeamService"
---

<objective>
Create comprehensive unit tests for ExportDataService, ExportUtilityService, and StatisticsService.

Purpose: These services contain critical data transformation logic (export pipelines, attendance calculations, leaderboard ranking) that currently has zero test coverage. Testing prevents regressions in export data structure and catches division-by-zero bugs in statistics calculations.

Output: Two test files with 30+ test cases covering all public methods, edge cases, and data validation.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/lib/services/export/export_data_service.dart
@backend/lib/services/export/export_utility_service.dart
@backend/lib/services/statistics_service.dart
@backend/lib/db/database.dart
@backend/lib/db/supabase_client.dart
@backend/test/helpers/test_helpers.dart
@backend/test/helpers/test_data.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export service tests with mocktail-based mocking</name>
  <files>backend/test/services/export_service_test.dart</files>
  <action>
Create `backend/test/services/export_service_test.dart` with comprehensive tests for ExportDataService and ExportUtilityService.

**Mocking approach:** Use mocktail to mock `Database` and `SupabaseClient` (from `backend/lib/db/`). The services call `_db.client.select(tableName, filters: ..., order: ..., select: ...)` which returns `Future<List<Map<String, dynamic>>>`. Mock these calls with `when(() => client.select(...)).thenAnswer(...)`.

Create mock classes:
```dart
import 'package:mocktail/mocktail.dart';
import 'package:core_idrett_backend/db/database.dart';
import 'package:core_idrett_backend/db/supabase_client.dart';

class MockDatabase extends Mock implements Database {}
class MockSupabaseClient extends Mock implements SupabaseClient {}
```

Wire up: `when(() => db.client).thenReturn(mockClient);`

**ExportDataService tests (5 groups, one per export type):**

1. `exportLeaderboard` group:
   - Returns correct structure with type='leaderboard', columns=['Plass', 'Bruker', 'Poeng']
   - Returns empty data array when no entries
   - Maps user names correctly from user lookup
   - Assigns sequential ranks
   - Handles seasonId and leaderboardId filter params

2. `exportAttendance` group:
   - Returns correct structure with type='attendance'
   - Returns zero attendance when no activities exist (verifies 0 rate, not NaN)
   - Calculates attendance rate correctly (attended/total*100, rounded)
   - Sorts by attendance rate descending
   - Handles fromDate/toDate filters

3. `exportFines` group:
   - Returns correct structure with type='fines' and summary
   - Returns empty summary (zeros) when no fines
   - Calculates total_amount, paid_amount, unpaid_amount correctly
   - Handles paidOnly=true and paidOnly=false filters
   - Maps rule names and user names correctly

4. `exportMembers` group:
   - Returns correct structure with type='members'
   - Returns empty data when no active members
   - Maps roles correctly (Admin, Botesjef, trainer type)
   - Sorts by name alphabetically

5. `exportActivities` group:
   - Returns correct structure with type='activities'
   - Returns empty data when no activities
   - Maps template names and types
   - Calculates attending_count from participants
   - Handles date range filters

**ExportUtilityService tests (1 group):**
- `generateCsv`: Generates header row with semicolon delimiter
- `generateCsv`: Formats boolean values as Ja/Nei
- `generateCsv`: Escapes values containing semicolons with quotes
- `generateCsv`: Handles null values as empty strings
- `generateCsv`: Empty data produces header-only CSV

Use `any(named: 'filters')` or explicit filter matchers depending on what is needed. For select calls that need specific return data, match on table name and use `any()` for other params.

**Important:** The SupabaseClient.select() signature is:
```dart
Future<List<Map<String, dynamic>>> select(String table, {String? select, Map<String, String>? filters, String? order, int? limit, int? offset})
```
Mock accordingly.
  </action>
  <verify>Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test test/services/export_service_test.dart` — all tests pass.</verify>
  <done>ExportDataService has tests for all 5 export types with structure validation and edge cases. ExportUtilityService has CSV generation tests. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create statistics service tests with edge case coverage</name>
  <files>backend/test/services/statistics_service_test.dart</files>
  <action>
Create `backend/test/services/statistics_service_test.dart` with comprehensive tests for StatisticsService.

**Mocking approach:** StatisticsService depends on Database, UserService, TeamService, and PlayerRatingService. Mock all four:
```dart
class MockDatabase extends Mock implements Database {}
class MockSupabaseClient extends Mock implements SupabaseClient {}
class MockUserService extends Mock implements UserService {}
class MockTeamService extends Mock implements TeamService {}
class MockPlayerRatingService extends Mock implements PlayerRatingService {}
```

Wire up: `service = StatisticsService(db, userService, teamService, playerRatingService);`

**Test groups:**

1. `getLeaderboard` group:
   - Returns empty list when team has no members (getTeamMemberUserIds returns [])
   - Returns leaderboard sorted by points descending, then by rating
   - Assigns correct sequential ranks (1, 2, 3...)
   - Handles missing season stats (defaults to 0 points)
   - Handles missing player ratings (defaults to 1000.0 rating)
   - Filters by seasonYear parameter (uses provided year, not DateTime.now().year)

2. `getPlayerStatistics` group:
   - Returns null when user is not a team member
   - Returns null when user doesn't exist
   - Returns statistics with 0 totalActivities and 0.0 attendancePercentage when team has no activities
   - Calculates attendancePercentage correctly (attended/total*100)
   - Returns 0.0 percentage when totalActivities is 0 (division-by-zero prevention)
   - Includes current season stats when available
   - Includes player rating from PlayerRatingService

3. `getTeamAttendance` group:
   - Returns empty list when team has no members
   - Returns records with 0 totalActivities and 0.0 percentage when team has no activities
   - Calculates attendance correctly for multiple users
   - Sorts by percentage descending
   - Handles date range filtering (fromDate/toDate)
   - Returns 0.0 percentage (not NaN/Infinity) when totalActivities is 0

4. `addPoints` group:
   - Creates new season_stats row when none exists for user+team+year
   - Increments existing total_points when season_stats exists

5. `recordMatchResult` group:
   - Creates new season_stats with win/loss/draw column set to 1
   - Increments existing win/loss/draw count
   - Ignores invalid result strings (not 'win', 'loss', 'draw')

**Key mock patterns:**
- `when(() => teamService.getTeamMemberUserIds(any())).thenAnswer((_) async => ['user-1', 'user-2']);`
- `when(() => userService.getUserMap(any())).thenAnswer((_) async => {'user-1': {'id': 'user-1', 'name': 'Test', 'avatar_url': null}});`
- `when(() => playerRatingService.getPlayerRating(any(), any())).thenAnswer((_) async => 1000.0);`
- For DB selects: `when(() => client.select('season_stats', filters: any(named: 'filters'))).thenAnswer((_) async => []);`
  </action>
  <verify>Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test test/services/statistics_service_test.dart` — all tests pass.</verify>
  <done>StatisticsService has tests for getLeaderboard, getPlayerStatistics, getTeamAttendance, addPoints, and recordMatchResult. Edge cases (empty teams, zero activities, division-by-zero) all verified. All tests pass.</done>
</task>

</tasks>

<verification>
```bash
cd "/Users/karsten/NextCore/Core - Idrett/backend"
dart test test/services/
dart test  # All existing tests still pass
```
</verification>

<success_criteria>
- Export service test file exists with 15+ tests covering all 5 export types + CSV generation
- Statistics service test file exists with 15+ tests covering leaderboard, attendance, player stats
- Zero-division edge cases explicitly tested (0 activities returns 0.0 percentage)
- All tests pass independently and alongside existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/06-feature-test-coverage/06-01-SUMMARY.md`
</output>
