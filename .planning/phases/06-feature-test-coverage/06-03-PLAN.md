---
phase: 06-feature-test-coverage
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - app/test/helpers/mock_repositories.dart
  - app/test/features/export/export_screen_test.dart
  - app/test/features/mini_activities/tournament_screen_test.dart
autonomous: true

must_haves:
  truths:
    - "Frontend export screen test verifies all 5 export type cards rendered for admin"
    - "Frontend export screen test verifies members export hidden for non-admin"
    - "Frontend export screen test verifies export history section rendered"
    - "Frontend tournament screen test verifies loading state renders CircularProgressIndicator"
    - "Frontend tournament screen test verifies tournament content renders with bracket and match cards"
    - "MockExportRepository and MockTournamentRepository added to test infrastructure"
  artifacts:
    - path: "app/test/features/export/export_screen_test.dart"
      provides: "Export screen widget tests"
      min_lines: 80
    - path: "app/test/features/mini_activities/tournament_screen_test.dart"
      provides: "Tournament screen widget tests"
      min_lines: 80
    - path: "app/test/helpers/mock_repositories.dart"
      provides: "Updated mock infrastructure with export and tournament mocks"
  key_links:
    - from: "app/test/features/export/export_screen_test.dart"
      to: "app/lib/features/export/presentation/export_screen.dart"
      via: "ProviderScope with MockExportRepository overrides"
      pattern: "ExportScreen|MockExportRepository"
    - from: "app/test/features/mini_activities/tournament_screen_test.dart"
      to: "app/lib/features/mini_activities/presentation/screens/tournament_screen.dart"
      via: "ProviderScope with MockTournamentRepository overrides"
      pattern: "TournamentScreen|MockTournamentRepository"
---

<objective>
Create widget tests for the ExportScreen and TournamentScreen, adding the necessary mock repositories to the test infrastructure.

Purpose: Frontend screens for export and tournament features currently have zero test coverage. Widget tests verify that the UI renders correctly, shows/hides elements based on role, and handles async state (loading, error, data).

Output: Two widget test files and updated mock_repositories.dart with export and tournament mock support.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/lib/features/export/presentation/export_screen.dart
@app/lib/features/export/data/export_repository.dart
@app/lib/features/export/providers/export_provider.dart
@app/lib/features/mini_activities/presentation/screens/tournament_screen.dart
@app/lib/features/mini_activities/data/tournament_repository.dart
@app/lib/features/mini_activities/providers/tournament_provider.dart
@app/test/helpers/mock_repositories.dart
@app/test/helpers/test_app.dart
@app/test/helpers/test_data.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MockExportRepository and MockTournamentRepository to test infrastructure</name>
  <files>app/test/helpers/mock_repositories.dart</files>
  <action>
Update `app/test/helpers/mock_repositories.dart` to add mock classes and provider overrides for export and tournament repositories.

**Add imports:**
```dart
import 'package:core_idrett/features/export/data/export_repository.dart';
import 'package:core_idrett/features/export/providers/export_provider.dart';
import 'package:core_idrett/data/models/export_log.dart';
import 'package:core_idrett/features/mini_activities/data/tournament_repository.dart';
import 'package:core_idrett/features/mini_activities/providers/tournament_provider.dart';
import 'package:core_idrett/data/models/tournament.dart';
```

**Add mock classes (in the Mock Classes section):**
```dart
class MockExportRepository extends Mock implements ExportRepository {}
class MockTournamentRepository extends Mock implements TournamentRepository {}
```

**Update MockProviders class:**
- Add fields: `final MockExportRepository exportRepository;` and `final MockTournamentRepository tournamentRepository;`
- Initialize in constructor
- Add to overrides list: `exportRepositoryProvider.overrideWithValue(exportRepository)` and `tournamentRepositoryProvider.overrideWithValue(tournamentRepository)`

**Add setup methods to MockProviders:**
```dart
/// Setup export history
void setupExportHistory(String teamId, List<ExportLog> logs) {
  when(() => exportRepository.getExportHistory(teamId, limit: any(named: 'limit')))
      .thenAnswer((_) async => logs);
}

/// Setup export data
void setupExportLeaderboard(String teamId, ExportData data) {
  when(() => exportRepository.exportLeaderboard(teamId,
    format: any(named: 'format'),
    seasonId: any(named: 'seasonId'),
    leaderboardId: any(named: 'leaderboardId'),
  )).thenAnswer((_) async => data);
}

/// Setup tournament fetch
void setupGetTournament(Tournament tournament) {
  when(() => tournamentRepository.getTournament(tournament.id))
      .thenAnswer((_) async => tournament);
}
```

**Add fallback values in registerFallbackValues():**
```dart
registerFallbackValue(ExportType.leaderboard);
registerFallbackValue(TournamentType.singleElimination);
```

Check the actual provider names by reading the export_provider.dart and tournament_provider.dart files. The exportRepositoryProvider and tournamentRepositoryProvider should already be defined as `Provider<ExportRepository>` and `Provider<TournamentRepository>` in the repository files, so the override pattern should work.
  </action>
  <verify>Run `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter analyze lib/features/export/ test/helpers/` — no new errors.</verify>
  <done>MockExportRepository and MockTournamentRepository added to mock_repositories.dart with provider overrides and setup helper methods.</done>
</task>

<task type="auto">
  <name>Task 2: Create export screen and tournament screen widget tests</name>
  <files>
    app/test/features/export/export_screen_test.dart
    app/test/features/mini_activities/tournament_screen_test.dart
  </files>
  <action>
**Create `app/test/features/export/export_screen_test.dart`:**

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:mocktail/mocktail.dart';
// Import screen, widgets, providers, models
// Import test helpers
```

Test groups:

1. `ExportScreen rendering` group:
   - Admin user sees all 5 ExportOptionCard widgets (leaderboard, attendance, fines, activities, members)
   - Non-admin user sees 4 ExportOptionCard widgets (members hidden when isAdmin=false)
   - Screen title shows 'Eksporter data'
   - Section header 'Velg hva du vil eksportere' is visible
   - Export history section header 'Eksporthistorikk' is visible

2. `ExportScreen with export history` group:
   - Empty history shows 'Ingen eksporter enna' message
   - History with entries renders ExportHistoryTile widgets

**Setup pattern for each test:**
```dart
final scenario = TestScenario();
scenario.setupLoggedIn();
// Mock export history provider
scenario.mocks.setupExportHistory('team-1', []);

await tester.pumpWidget(
  createTestWidget(
    const ExportScreen(teamId: 'team-1', isAdmin: true),
    overrides: scenario.overrides,
  ),
);
await tester.pumpAndSettle();
```

**Important:** The ExportScreen uses `ref.watch(exportNotifierProvider(widget.teamId))` and `ref.watch(exportHistoryProvider(widget.teamId))`. Check these provider definitions to determine what needs to be mocked. The exportHistoryProvider likely depends on exportRepositoryProvider, so overriding the repository should work. The exportNotifierProvider may need additional setup — check the provider file.

If the providers use family providers or AsyncNotifiers that are hard to override, consider directly overriding the provider with a mock value:
```dart
exportHistoryProvider('team-1').overrideWith((ref) async => <ExportLog>[]),
exportNotifierProvider('team-1').overrideWith(() => MockExportNotifier()),
```

Use `find.byType(ExportOptionCard)` to count export options and `find.text(...)` for text assertions.

**Create `app/test/features/mini_activities/tournament_screen_test.dart`:**

Test groups:

1. `TournamentScreen loading state` group:
   - Shows CircularProgressIndicator while tournament is loading

2. `TournamentScreen with data` group:
   - Renders tournament content when data is loaded
   - Shows tournament name/title in AppBar

**Setup pattern:**
```dart
final scenario = TestScenario();
scenario.setupLoggedIn();

// Create a test tournament
final tournament = Tournament(
  id: 'tourn-1',
  miniActivityId: 'mini-1',
  tournamentType: TournamentType.singleElimination,
  // ... other required fields
);

// Override tournament provider
await tester.pumpWidget(
  createTestWidget(
    const TournamentScreen(
      tournamentId: 'tourn-1',
      miniActivityId: 'mini-1',
    ),
    overrides: [
      ...scenario.overrides,
      tournamentProvider('tourn-1').overrideWith((ref) async => tournament),
    ],
  ),
);
```

**Important:** The TournamentScreen uses `ref.watch(tournamentProvider(tournamentId))` which returns AsyncValue. For the loading test, use `pump()` (not pumpAndSettle) to catch the loading state. For the data test, use `pumpAndSettle()` after overriding with resolved data.

Check the actual Tournament model constructor to provide correct required fields. Look at the test data factories (TestTournamentFactory if it exists, or construct manually).

If providers are difficult to override directly, a simpler approach is to override the repository and let the real providers fetch from the mock:
```dart
tournamentRepositoryProvider.overrideWithValue(mockTournamentRepo),
```
And set up: `when(() => mockTournamentRepo.getTournament('tourn-1')).thenAnswer((_) async => tournament);`
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter test test/features/export/export_screen_test.dart test/features/mini_activities/tournament_screen_test.dart` — all tests pass.
  </verify>
  <done>Export screen widget tests verify 5 export types for admin, 4 for non-admin, and history rendering. Tournament screen widget tests verify loading and data states. All tests pass.</done>
</task>

</tasks>

<verification>
```bash
cd "/Users/karsten/NextCore/Core - Idrett/app"
flutter test test/features/export/
flutter test test/features/mini_activities/
flutter test  # All existing tests still pass
```
</verification>

<success_criteria>
- Export screen test file exists with 5+ widget tests covering admin/non-admin rendering and history
- Tournament screen test file exists with 3+ widget tests covering loading and data states
- MockExportRepository and MockTournamentRepository in mock_repositories.dart
- All widget tests pass alongside existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/06-feature-test-coverage/06-03-SUMMARY.md`
</output>
