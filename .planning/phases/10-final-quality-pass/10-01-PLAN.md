---
phase: 10-final-quality-pass
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/test/features/activities/activities_list_test.dart
  - app/test/features/activities/activity_detail_test.dart
  - app/test/features/chat/chat_test.dart
  - app/test/features/fines/my_fines_test.dart
  - app/test/features/fines/fine_rules_test.dart
  - app/test/features/teams/teams_list_test.dart
  - app/test/features/teams/team_detail_test.dart
  - app/test/features/teams/create_team_test.dart
  - app/test/features/mini_activities/tournament_screen_test.dart
  - app/test/features/export/export_screen_test.dart
  - app/test/helpers/test_data.dart
  - app/test/models/mini_activity_models_test.dart
  - app/lib/data/models/tournament_models.dart
  - app/lib/data/models/statistics_player.dart
  - app/lib/data/models/stopwatch.dart
  - app/lib/data/models/tournament_group_models.dart
  - backend/test/services/fine_service_test.dart
autonomous: true

must_haves:
  truths:
    - "All 274 frontend tests pass with zero failures"
    - "Flutter analyze shows zero errors and only 5 accepted pre-existing warnings"
    - "Dart analyze backend shows zero errors and zero warnings"
  artifacts:
    - path: "app/test/features/activities/activities_list_test.dart"
      provides: "Fixed error state test"
    - path: "app/test/features/activities/activity_detail_test.dart"
      provides: "Fixed error state test"
    - path: "app/test/features/chat/chat_test.dart"
      provides: "Fixed error state and retry tests"
  key_links:
    - from: "flutter test"
      to: "all test files"
      via: "test runner"
      pattern: "+274 -0"
    - from: "flutter analyze"
      to: "all lib files"
      via: "static analysis"
      pattern: "5 issues found"
---

<objective>
Fix all 12 failing frontend tests and clean all fixable static analysis issues across frontend and backend.

Purpose: Achieve zero test failures and clean static analysis as prerequisites for the final quality sign-off. The 12 test failures are concentrated in error state assertions (widget not found after async state change). The 62 fixable analysis issues include 55 const constructor suggestions (auto-fixable), 3 duplicate imports, 3 unused imports, 1 unused field, and 1 backend unused import.

Output: All tests green, static analysis shows only 5 accepted pre-existing warnings.
</objective>

<execution_context>
@/Users/karsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/karsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-final-quality-pass/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix 12 failing frontend widget tests</name>
  <files>
    app/test/features/activities/activities_list_test.dart
    app/test/features/activities/activity_detail_test.dart
    app/test/features/chat/chat_test.dart
    app/test/features/fines/my_fines_test.dart
    app/test/features/fines/fine_rules_test.dart
    app/test/features/teams/teams_list_test.dart
    app/test/features/teams/team_detail_test.dart
    app/test/features/teams/create_team_test.dart
    app/test/features/mini_activities/tournament_screen_test.dart
  </files>
  <action>
Fix 12 failing tests across 9 test files. All failures share a common root cause: error state assertions fail because the widget under test does not render the expected error icon or retry button when the provider returns `AsyncValue.error()`.

**Diagnosis pattern:** Tests set a provider to `AsyncValue.error(Exception('msg'), StackTrace.empty)` then look for `Icons.error` (U+0E238) or a retry button. The widget either (a) doesn't render the expected icon in its `when2()` error branch, or (b) the test doesn't wait for the async state to propagate.

**Fix approach for each failing test:**

1. Read each failing test file to understand what widget/icon/button it expects in error state.
2. Read the corresponding screen/widget file to see what the `when2()` error branch actually renders.
3. Update the test assertion to match the actual error state rendering (the screens were refactored in Phases 5-7, but tests weren't updated).
4. If the screen does not render an error state at all, add a simple error state render with `EmptyStateWidget` or the existing error pattern.

**Specific failures by file:**
- `activities_list_test.dart`: 1 failure - "shows error state with retry button" - expects `Icons.error` icon
- `activity_detail_test.dart`: 1 failure - "shows error state when loading fails" - expects error icon
- `chat_test.dart`: 3 failures - "renders app bar with title on narrow screen", "shows error state when loading fails", "shows retry button on error" - expects error state rendering
- `my_fines_test.dart`: 1 failure - "shows error state when loading fails" - expects error icon
- `fine_rules_test.dart`: 1 failure - "shows error state when loading fails" - expects error icon
- `teams_list_test.dart`: 1 failure - "shows error state with retry button" - expects error icon
- `team_detail_test.dart`: 1 failure - "shows error when team load fails" - expects error icon
- `create_team_test.dart`: 1 failure - "shows error snackbar when creation fails" - expects snackbar behavior
- `tournament_screen_test.dart`: 2 failures - "renders tournament content when data is loaded", "shows Grupper tab for group tournament types" - data rendering assertions

Do NOT change widget implementation. Only update test expectations to match current widget behavior, OR fix test setup (mock provider state, pumpAndSettle timing) so the existing assertion works correctly.
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter test` — all tests pass with zero failures. The summary line should show `+274 -0` or similar with no failures.
  </verify>
  <done>All 12 previously failing tests now pass. Zero test regressions introduced. Total frontend test count remains 274 or higher.</done>
</task>

<task type="auto">
  <name>Task 2: Clean all fixable static analysis issues</name>
  <files>
    app/lib/data/models/statistics_player.dart
    app/lib/data/models/stopwatch.dart
    app/lib/data/models/tournament_group_models.dart
    app/lib/data/models/tournament_models.dart
    app/test/features/export/export_screen_test.dart
    app/test/features/mini_activities/tournament_screen_test.dart
    app/test/helpers/test_data.dart
    app/test/models/mini_activity_models_test.dart
    backend/test/services/fine_service_test.dart
  </files>
  <action>
Clean all fixable static analysis warnings across frontend and backend. The 5 pre-existing deprecation/lint warnings are ACCEPTED and should NOT be touched.

**Frontend (62 fixable issues):**

1. **55 `prefer_const_constructors_in_immutables` (info):** Run `cd app && dart fix --apply` to auto-add `const` to constructors in `@immutable` classes. These are in: `statistics_player.dart` (6), `stopwatch.dart` (3), `tournament_group_models.dart` (5), `tournament_models.dart` (4), and ~37 others. The `dart fix` command handles these automatically.

2. **3 `duplicate_import` (warning):** Remove duplicate import lines in the affected files. These are likely in `tournament_models.dart` and 2 other files. Find and remove the second occurrence of each duplicated import.

3. **3 `unused_import` (warning):** Remove unused imports in:
   - `test/features/export/export_screen_test.dart` (mocktail)
   - `test/features/mini_activities/tournament_screen_test.dart` (tournament_provider)
   - `test/models/mini_activity_models_test.dart` (mini_activity_support)

4. **1 `unused_field` (warning):** Remove or use `_counter` field in `test/helpers/test_data.dart`.

**Backend (1 fixable issue):**

5. **1 `unused_import` (warning):** Remove unused import of `fine.dart` in `backend/test/services/fine_service_test.dart`.

**DO NOT touch these 5 accepted pre-existing warnings:**
- `deprecated_member_use` in `export_screen.dart` (Share/shareXFiles deprecated)
- `deprecated_member_use` in `team_division_sheet.dart` (RadioGroup groupValue/onChanged deprecated)
- `use_build_context_synchronously` in `set_winner_dialog.dart`

After all fixes, run `flutter analyze` and `dart analyze` to verify only the 5 accepted warnings remain.
  </action>
  <verify>
Run `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter analyze` — should show exactly 5 issues (the accepted pre-existing warnings).
Run `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze` — should show 0 issues.
Run `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter test` — all tests still pass (no regressions from analysis fixes).
  </verify>
  <done>Flutter analyze shows exactly 5 issues (all accepted pre-existing warnings). Dart analyze backend shows 0 issues. All frontend tests still pass after cleanup.</done>
</task>

</tasks>

<verification>
1. `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter test` — 274+ tests pass, 0 failures
2. `cd "/Users/karsten/NextCore/Core - Idrett/app" && flutter analyze` — exactly 5 issues (accepted)
3. `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart analyze` — 0 issues
4. `cd "/Users/karsten/NextCore/Core - Idrett/backend" && dart test` — 361 tests pass
</verification>

<success_criteria>
- All frontend tests pass with zero failures
- Flutter analyze shows zero errors and only the 5 accepted pre-existing warnings
- Dart analyze backend shows zero errors and zero warnings
- All backend tests continue passing
</success_criteria>

<output>
After completion, create `.planning/phases/10-final-quality-pass/10-01-SUMMARY.md`
</output>
